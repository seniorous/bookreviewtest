<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ä¹¦è¯„ç®¡ç†ç³»ç»Ÿ - é¦–é¡µ</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- Markdownæ”¯æŒ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- é…ç½®æ–‡ä»¶ -->
<script src="config.js"></script>

<style>
*{box-sizing:border-box}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Segoe UI",Roboto,"Noto Sans CJK SC","Microsoft YaHei","Helvetica Neue",Arial}
a{color:#ff6a00;text-decoration:none}
a:hover{text-decoration:underline}
.header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee}
.nav{max-width:1200px;margin:auto;display:flex;align-items:center;gap:20px;padding:12px 16px}
.brand{font-weight:700;color:#ff6a00}
.nav-spacer{flex:1}
.btn{display:inline-block;padding:10px 16px;border:none;border-radius:8px;background:#ff6a00;color:#fff;cursor:pointer}
.btn.secondary{background:#eee;color:#333}
.container{max-width:1200px;margin:auto;padding:20px 16px}
.search{display:flex;gap:8px;margin:12px 0 20px}
.search input{flex:1;padding:10px 12px;border:1px solid #ddd;border-radius:8px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.card{border:1px solid #eee;border-radius:12px;padding:16px;background:#fff}
.card h3{margin:6px 0 8px;font-size:18px}
.meta{color:#666;font-size:13px;margin-bottom:8px}
.badge{display:inline-block;background:#ffe8d9;color:#a34b00;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
.empty{padding:60px 0;text-align:center;color:#999}
.footer{color:#999;font-size:12px;text-align:center;margin:24px 0}
.star{font-size:14px;color:#ff6a00}
.contest-banner{background:linear-gradient(135deg,#ff6a00 0%,#e55a4f 100%);color:#fff;border-radius:12px;padding:20px;margin:20px 0;text-align:center;position:relative;overflow:hidden}
.contest-banner::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent,rgba(255,255,255,0.1),transparent);transform:rotate(45deg);animation:shine 3s infinite}
@keyframes shine{0%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}100%{transform:translateX(100%) translateY(100%) rotate(45deg)}}
.contest-title{font-size:24px;font-weight:bold;margin-bottom:10px;position:relative;z-index:1}
.contest-subtitle{font-size:16px;margin-bottom:15px;opacity:0.9;position:relative;z-index:1}
.countdown-container{display:flex;justify-content:center;gap:15px;margin:15px 0;position:relative;z-index:1}
.countdown-item{background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;min-width:60px}
.countdown-number{display:block;font-size:24px;font-weight:bold;line-height:1}
.countdown-label{font-size:12px;opacity:0.9;margin-top:5px}
.countdown-separator{font-size:20px;align-self:center;animation:blink 1s infinite}
@keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0.3}}
.contest-button{background:rgba(255,255,255,0.2);color:#fff;border:2px solid rgba(255,255,255,0.3);padding:10px 20px;border-radius:25px;font-size:14px;cursor:pointer;transition:all 0.3s;position:relative;z-index:1}
.contest-button:hover{background:rgba(255,255,255,0.3);border-color:rgba(255,255,255,0.5)}
.book-cover{width:60px;height:80px;background:#f0f0f0;border-radius:6px;margin-right:12px;background-size:cover;background-position:center;border:1px solid #ddd;cursor:pointer;transition:transform 0.2s}
.book-cover:hover{transform:scale(1.05)}
.book-cover.placeholder{display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;text-align:center}
.card-with-cover{display:flex;align-items:flex-start}
.card-content{flex:1}
.cover-upload{position:relative;display:inline-block}
.cover-upload input{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer}
.loading{display:flex;justify-content:center;align-items:center;padding:40px;color:#666}
.loading::after{content:'';width:20px;height:20px;border:2px solid #ff6a00;border-top:2px solid transparent;border-radius:50%;animation:spin 1s linear infinite;margin-left:10px}
@keyframes spin{to{transform:rotate(360deg)}}
/* Markdownæ¸²æŸ“æ ·å¼ */
.markdown-content h1,.markdown-content h2,.markdown-content h3{color:#333;margin:16px 0 8px 0}
.markdown-content h1{font-size:1.5em}
.markdown-content h2{font-size:1.3em}
.markdown-content h3{font-size:1.1em}
.markdown-content p{margin:8px 0}
.markdown-content code{background:#f5f5f5;padding:2px 4px;border-radius:3px;font-family:'Courier New',monospace}
.markdown-content pre{background:#f5f5f5;padding:12px;border-radius:6px;overflow-x:auto}
.markdown-content blockquote{border-left:4px solid #ff6a00;margin:8px 0;padding-left:16px;color:#666}
.markdown-content ul,.markdown-content ol{padding-left:20px}
.markdown-content strong{font-weight:bold}
.markdown-content em{font-style:italic}
</style>
</head>
<body>
<header class="header">
  <div class="nav">
    <div class="brand">ğŸ“š BookReviewer</div>
    <a href="index.html">é¦–é¡µ</a>
    <a href="pages/add-review.html">å‘å¸ƒä¹¦è¯„</a>
    <div class="nav-spacer"></div>
    <div id="authArea"></div>
  </div>
</header>

<main class="container">
  <!-- é‰´èµæ–‡ç« å¾é›†æ´»åŠ¨æ¨ªå¹… -->
  <div class="contest-banner" id="contestBanner">
    <div class="contest-title">ğŸ“– ä¼˜ç§€ä¹¦è¯„é‰´èµæ–‡ç« å¾é›†ä¸­</div>
    <div class="contest-subtitle">åˆ†äº«ä½ çš„é˜…è¯»æ„Ÿæ‚Ÿï¼Œèµ¢å–ç²¾ç¾å¥–å“</div>
    <div class="countdown-container" id="countdownContainer">
      <div class="countdown-item">
        <span class="countdown-number" id="days">15</span>
        <div class="countdown-label">å¤©</div>
      </div>
      <div class="countdown-separator">:</div>
      <div class="countdown-item">
        <span class="countdown-number" id="hours">08</span>
        <div class="countdown-label">æ—¶</div>
      </div>
      <div class="countdown-separator">:</div>
      <div class="countdown-item">
        <span class="countdown-number" id="minutes">30</span>
        <div class="countdown-label">åˆ†</div>
      </div>
      <div class="countdown-separator">:</div>
      <div class="countdown-item">
        <span class="countdown-number" id="seconds">45</span>
        <div class="countdown-label">ç§’</div>
      </div>
    </div>
    <button class="contest-button" onclick="location.href='pages/add-review.html'">ç«‹å³å‚ä¸</button>
  </div>
  
  <div class="search">
    <input id="q" placeholder="æœç´¢ä¹¦å / ä½œè€… / ä¹¦è¯„æ ‡é¢˜">
    <button class="btn" id="doSearch">æœç´¢</button>
  </div>
  <div id="list" class="grid"></div>
  <div id="empty" class="empty" style="display:none;">è¿˜æ²¡æœ‰ä¹¦è¯„ï¼Œå» <a href="pages/add-review.html">å‘å¸ƒä¸€æ¡</a> è¯•è¯•</div>
  <div class="footer">Â© 2025 ä¹¦è¯„ç®¡ç†ç³»ç»Ÿï¼ˆè¯¾ç¨‹ä½œä¸šæ¼”ç¤ºï¼‰</div>
</main>

<script>
// åˆå§‹åŒ–Firebase
firebase.initializeApp(CONFIG.firebase);
const db = firebase.firestore();                      
const auth = firebase.auth();


// GitHubé…ç½®ä»CONFIGå¯¹è±¡è·å–
const GITHUB_CONFIG = CONFIG.github;

// å…¨å±€å˜é‡
let currentUser = null;
let allReviews = [];

// Firebaseæ•°æ®æ“ä½œç±»
class FirebaseDB {
  // è·å–æ‰€æœ‰ä¹¦è¯„ï¼ˆåŒ…å«å…³è”æ•°æ®ï¼‰
  static async getAllReviews() {
    try {
      const reviewsSnapshot = await db.collection('reviews')
        .orderBy('createdAt', 'desc')
        .get();
      
      const booksSnapshot = await db.collection('books').get();
      const usersSnapshot = await db.collection('users').get();
      
      const books = {};
      const users = {};
      
      booksSnapshot.forEach(doc => {
        books[doc.id] = { id: doc.id, ...doc.data() };
      });
      
      usersSnapshot.forEach(doc => {
        users[doc.id] = { id: doc.id, ...doc.data() };
      });
      
      const reviews = reviewsSnapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          ...data,
          book: books[data.bookId] || { title: 'æœªçŸ¥ä¹¦ç±', author: 'æœªçŸ¥' },
          user: users[data.userId] || { username: 'åŒ¿åç”¨æˆ·' },
          created_at: data.createdAt?.toMillis() || Date.now()
        };
      });
      
      return reviews;
    } catch (error) {
      console.error('è·å–ä¹¦è¯„å¤±è´¥:', error);
      return [];
    }
  }
  
  // æŸ¥æ‰¾æˆ–åˆ›å»ºä¹¦ç±
  static async findOrCreateBook(title, author) {
    try {
      const booksSnapshot = await db.collection('books')
        .where('title', '==', title)
        .where('author', '==', author)
        .get();
      
      if (!booksSnapshot.empty) {
        return booksSnapshot.docs[0].id;
      }
      
      // åˆ›å»ºæ–°ä¹¦ç±
      const bookRef = await db.collection('books').add({
        title,
        author,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      return bookRef.id;
    } catch (error) {
      console.error('æŸ¥æ‰¾æˆ–åˆ›å»ºä¹¦ç±å¤±è´¥:', error);
      throw error;
    }
  }
  
  // GitHubå›¾åºŠä¸Šä¼ å°é¢å›¾ç‰‡
  static async uploadCoverToGitHub(file, bookId) {
    try {
      // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
      const timestamp = Date.now();
      const extension = file.name.split('.').pop();
      const fileName = `cover-${bookId}-${timestamp}.${extension}`;
      
      // å°†æ–‡ä»¶è½¬æ¢ä¸ºBase64
      const base64Content = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1]; // ç§»é™¤data:image/...;base64,å‰ç¼€
          resolve(base64);
        };
        reader.readAsDataURL(file);
      });

      // GitHub API URL
      const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/images/${fileName}`;

      // ä¸Šä¼ åˆ°GitHub
      const response = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_CONFIG.token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: `Upload book cover: ${fileName}`,
          content: base64Content,
          branch: GITHUB_CONFIG.branch
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`GitHub upload failed: ${response.status} - ${errorData.message || 'Unknown error'}`);
      }

      // è¿”å›å›¾ç‰‡çš„ç›´æ¥è®¿é—®URL
      const downloadURL = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/images/${fileName}`;
      
      // æ›´æ–°ä¹¦ç±å°é¢URLåˆ°Firestore
      await db.collection('books').doc(bookId).update({
        cover: downloadURL
      });
      
      return downloadURL;
    } catch (error) {
      console.error('GitHubå›¾åºŠä¸Šä¼ å¤±è´¥:', error);
      throw error;
    }
  }
}

// --- è§†å›¾ ---
const elAuth = document.getElementById('authArea');
const elList = document.getElementById('list');
const elEmpty = document.getElementById('empty');
const elQ = document.getElementById('q');

function renderAuth(){
  if(currentUser){
    elAuth.innerHTML = `ä½ å¥½ï¼Œ${currentUser.displayName || currentUser.email} 
      <button class="btn secondary" onclick="logout()">é€€å‡º</button>`;
  }else{
    elAuth.innerHTML = `<a href="pages/login.html">ç™»å½•</a> / <a href="pages/register.html">æ³¨å†Œ</a>`;
  }
}

// é€€å‡ºç™»å½•
async function logout() {
  try {
    await auth.signOut();
    currentUser = null;
    renderAuth();
    alert('å·²é€€å‡ºç™»å½•');
  } catch (error) {
    alert('é€€å‡ºå¤±è´¥ï¼š' + error.message);
  }
}

function star(n){ return 'â˜…'.repeat(n) + 'â˜†'.repeat(5-n) }

function renderList(reviews = allReviews, query = ''){
  // è¿‡æ»¤æœç´¢
  const filteredReviews = query ? reviews.filter(item => {
    const searchText = query.toLowerCase();
    return [
      item.book?.title,
      item.book?.author,
      item.title
    ].some(text => text?.toLowerCase().includes(searchText));
  }) : reviews;
  
  if (filteredReviews.length === 0) {
    elEmpty.style.display = 'block';
    elList.style.display = 'none';
    return;
  }
  
  elEmpty.style.display = 'none';
  elList.style.display = 'grid';

  elList.innerHTML = filteredReviews.map(item=>`
    <article class="card card-with-cover">
      <div class="cover-upload" onclick="changeCover('${item.book.id}')">
        <div class="book-cover ${!item.book.cover ? 'placeholder' : ''}" 
             ${item.book.cover ? `style="background-image: url('${item.book.cover}')"` : ''}>
          ${!item.book.cover ? 'ç‚¹å‡»<br>é€‰æ‹©<br>å°é¢' : ''}
        </div>
        <input type="file" accept="image/*" onchange="handleCoverUpload(event, '${item.book.id}')" style="display:none">
      </div>
      <div class="card-content">
        <div class="meta">${item.book.title} <span class="badge">${item.book.author}</span></div>
        <h3>${item.title}</h3>
        <div class="meta">è¯„åˆ†ï¼š<span class="star">${star(item.rating)}</span> Â· ä½œè€…ï¼š${item.user.username || item.user.email}</div>
        <div class="markdown-content" style="color:#444;line-height:1.6">${marked.parse(item.content)}</div>
      </div>
    </article>
  `).join('');
}

document.getElementById('doSearch').onclick = ()=>renderList(allReviews, elQ.value);

// å›è½¦æœç´¢
elQ.onkeypress = (e) => {
  if (e.key === 'Enter') {
    document.getElementById('doSearch').click();
  }
};

// æ•°æ®åŠ è½½å‡½æ•°
async function loadReviews() {
  try {
    showLoading();
    allReviews = await FirebaseDB.getAllReviews();
    renderList(allReviews);
  } catch (error) {
    console.error('åŠ è½½ä¹¦è¯„å¤±è´¥:', error);
    alert('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
  } finally {
    hideLoading();
  }
}

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoading() {
  const loadingDiv = document.createElement('div');
  loadingDiv.id = 'loading';
  loadingDiv.className = 'loading';
  loadingDiv.textContent = 'æ­£åœ¨åŠ è½½ä¹¦è¯„...';
  elList.parentNode.insertBefore(loadingDiv, elList);
  elList.style.display = 'none';
  elEmpty.style.display = 'none';
}

function hideLoading() {
  const loadingDiv = document.getElementById('loading');
  if (loadingDiv) {
    loadingDiv.remove();
  }
  elList.style.display = 'grid';
}

// å€’è®¡æ—¶åŠŸèƒ½
function initCountdown() {
  const endTime = new Date().getTime() + (15 * 24 * 60 * 60 * 1000);
  
  function updateCountdown() {
    const now = new Date().getTime();
    const distance = endTime - now;
    
    if (distance > 0) {
      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);
      
      document.getElementById('days').textContent = String(days).padStart(2, '0');
      document.getElementById('hours').textContent = String(hours).padStart(2, '0');
      document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
      document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
    } else {
      document.getElementById('contestBanner').innerHTML = `
        <div class="contest-title">ğŸ“– å¾é›†æ´»åŠ¨å·²ç»“æŸ</div>
        <div class="contest-subtitle">æ„Ÿè°¢å¤§å®¶çš„ç§¯æå‚ä¸ï¼Œè·å¥–ç»“æœå³å°†å…¬å¸ƒ</div>
        <button class="contest-button" onclick="alert('æ´»åŠ¨å·²ç»“æŸï¼Œæ•¬è¯·æœŸå¾…ä¸‹æ¬¡æ´»åŠ¨ï¼')">æŸ¥çœ‹ç»“æœ</button>
      `;
    }
  }
  
  updateCountdown();
  setInterval(updateCountdown, 1000);
}

// å°é¢ç®¡ç†åŠŸèƒ½
function changeCover(bookId) {
  const input = event.currentTarget.querySelector('input[type="file"]');
  input.click();
}

async function handleCoverUpload(event, bookId) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
    return;
  }
  
  if (file.size > 2 * 1024 * 1024) {
    alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
    return;
  }
  
  // æ£€æŸ¥GitHubé…ç½®
  if (GITHUB_CONFIG.token === 'æ‚¨çš„GitHub Personal Access Token') {
    alert('è¯·å…ˆé…ç½®GitHub Tokenï¼\nè¯·åœ¨config.jsæ–‡ä»¶ä¸­å¡«å†™æ‚¨çš„Personal Access Token');
    return;
  }
  
  try {
    showLoading();
    await FirebaseDB.uploadCoverToGitHub(file, bookId);
    await loadReviews();
    alert('å°é¢æ›´æ–°æˆåŠŸï¼å›¾ç‰‡å·²ä¿å­˜åˆ°GitHub');
  } catch (error) {
    console.error('å°é¢ä¸Šä¼ è¯¦ç»†é”™è¯¯:', error);
    let errorMessage = 'å°é¢ä¸Šä¼ å¤±è´¥ï¼š';
    
    if (error.message.includes('GitHub upload failed: 401')) {
      errorMessage += 'GitHub Tokenæ— æ•ˆï¼Œè¯·æ£€æŸ¥Tokenæƒé™';
    } else if (error.message.includes('GitHub upload failed: 404')) {
      errorMessage += 'GitHubä»“åº“ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ä»“åº“é…ç½®';
    } else if (error.message.includes('GitHub upload failed: 403')) {
      errorMessage += 'GitHubæƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥Tokenæƒé™æ˜¯å¦åŒ…å«repo';
    } else {
      errorMessage += error.message;
    }
    
    alert(errorMessage);
  } finally {
    hideLoading();
  }
}

// ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
auth.onAuthStateChanged((user) => {
  currentUser = user;
  renderAuth();
});

// åˆå§‹åŒ–åº”ç”¨
document.addEventListener('DOMContentLoaded', () => {
  initCountdown();
  loadReviews();
});
</script>
</body>
</html>