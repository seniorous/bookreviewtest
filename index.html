<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ä¹¦è¯„ç®¡ç†ç³»ç»Ÿ - é¦–é¡µ</title>

<!-- APIå·¥å…·ç±» -->
<script src="js/api.js"></script>

<style>
*{box-sizing:border-box}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Segoe UI",Roboto,"Noto Sans CJK SC","Microsoft YaHei","Helvetica Neue",Arial}
a{color:#ff6a00;text-decoration:none}
a:hover{text-decoration:underline}
.header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee}
.nav{max-width:1200px;margin:auto;display:flex;align-items:center;gap:20px;padding:12px 16px}
.brand{font-weight:700;color:#ff6a00}
.nav-spacer{flex:1}
.btn{display:inline-block;padding:10px 16px;border:none;border-radius:8px;background:#ff6a00;color:#fff;cursor:pointer;text-decoration:none}
.btn.secondary{background:#eee;color:#333}
.btn:hover{text-decoration:none;opacity:0.9}
.container{max-width:1200px;margin:auto;padding:20px 16px}
.search{display:flex;gap:8px;margin:12px 0 20px}
.search input{flex:1;padding:10px 12px;border:1px solid #ddd;border-radius:8px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}
.card{border:1px solid #eee;border-radius:12px;padding:20px;background:#fff;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(135deg,#ff6a00 0%,#e55a4f 100%);opacity:0;transition:opacity 0.2s}
.card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.1);transform:translateY(-2px)}
.card:hover::before{opacity:1}
.card h3{margin:0 0 8px;font-size:18px;color:#333;line-height:1.3}
.meta{color:#666;font-size:14px;margin-bottom:12px;display:flex;align-items:center;flex-wrap:wrap;gap:8px}
.content{color:#555;line-height:1.5;margin-bottom:12px;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.rating{color:#ff6a00;font-size:16px;margin-bottom:8px;font-weight:600}
.stats{display:flex;gap:15px;font-size:13px;color:#999;flex-wrap:wrap}
.stats span{display:flex;align-items:center;gap:4px;white-space:nowrap}
.badge{display:inline-block;background:#ffe8d9;color:#a34b00;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
.empty{padding:60px 0;text-align:center;color:#999}
.footer{color:#999;font-size:12px;text-align:center;margin:40px 0 20px}
.loading{display:flex;justify-content:center;align-items:center;padding:40px;color:#666}
.loading::after{content:'';width:20px;height:20px;border:2px solid #ff6a00;border-top:2px solid transparent;border-radius:50%;animation:spin 1s linear infinite;margin-left:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.user-info{display:flex;align-items:center;gap:10px}
.avatar{width:32px;height:32px;border-radius:50%;background:#f0f0f0}
.contest-banner{background:linear-gradient(135deg,#ff6a00 0%,#e55a4f 100%);color:#fff;border-radius:12px;padding:20px;margin:20px 0;text-align:center}
.contest-title{font-size:24px;font-weight:bold;margin-bottom:10px}
.contest-subtitle{font-size:16px;margin-bottom:15px;opacity:0.9}
.contest-button{background:rgba(255,255,255,0.2);color:#fff;border:2px solid rgba(255,255,255,0.3);padding:10px 20px;border-radius:25px;cursor:pointer;transition:all 0.3s}
.contest-button:hover{background:rgba(255,255,255,0.3)}

/* Toastæç¤º */
.toast{position:fixed;top:20px;right:20px;background:#333;color:#fff;padding:12px 20px;border-radius:8px;z-index:1000;opacity:0;transform:translateX(100%);transition:all 0.3s ease}
.toast.show{opacity:1;transform:translateX(0)}
.toast.error{background:#e74c3c}
.toast.success{background:#27ae60}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .nav{padding:12px;flex-wrap:wrap;gap:12px}
  .brand{font-size:18px}
  .container{padding:16px 12px}
  .grid{grid-template-columns:1fr;gap:16px}
  .card{padding:16px}
  .contest-banner{margin:16px 0;padding:16px}
  .contest-title{font-size:20px}
  .contest-subtitle{font-size:14px}
  .search{flex-direction:column;gap:12px}
  .search input{padding:12px}
  .stats{gap:12px}
  .toast{top:10px;right:10px;left:10px;transform:translateY(-100%)}
  .toast.show{transform:translateY(0)}
}
</style>
</head>
<body>
<header class="header">
  <div class="nav">
    <div class="brand">ğŸ“š BookReviewer</div>
    <a href="index.html">é¦–é¡µ</a>
    <a href="pages/add-review.html">å‘å¸ƒä¹¦è¯„</a>
    <div class="nav-spacer"></div>
    <div id="authArea"></div>
  </div>
</header>

<main class="container">
  <!-- æ´»åŠ¨æ¨ªå¹… -->
  <div class="contest-banner">
    <div class="contest-title">ğŸ“– ä¼˜ç§€ä¹¦è¯„é‰´èµæ–‡ç« å¾é›†ä¸­</div>
    <div class="contest-subtitle">åˆ†äº«ä½ çš„é˜…è¯»æ„Ÿæ‚Ÿï¼Œèµ¢å–ç²¾ç¾å¥–å“</div>
    <button class="contest-button" onclick="location.href='pages/add-review.html'">ç«‹å³å‚ä¸</button>
  </div>
  
  <div class="search">
    <input id="searchInput" placeholder="æœç´¢ä¹¦å / ä½œè€… / ä¹¦è¯„æ ‡é¢˜" onkeypress="handleSearchKeyPress(event)">
    <button class="btn" onclick="performSearch()">æœç´¢</button>
  </div>
  
  <div id="reviewsList" class="grid"></div>
  <div id="loading" class="loading" style="display:none;">åŠ è½½ä¸­...</div>
  <div id="empty" class="empty" style="display:none;">è¿˜æ²¡æœ‰ä¹¦è¯„ï¼Œå» <a href="pages/add-review.html">å‘å¸ƒä¸€æ¡</a> è¯•è¯•</div>
  <div class="footer">Â© 2025 ä¹¦è¯„ç®¡ç†ç³»ç»Ÿï¼ˆè¯¾ç¨‹ä½œä¸šæ¼”ç¤ºï¼‰</div>
</main>

<script>
// å…¨å±€å˜é‡
let currentUser = null;
let allReviews = [];
let isLoading = false;

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async () => {
  console.log('ğŸ“š ä¹¦è¯„ç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–...');
  
  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  await checkAuthStatus();
  
  // åŠ è½½ä¹¦è¯„åˆ—è¡¨
  await loadReviews();
  
  console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
});

// æ£€æŸ¥è®¤è¯çŠ¶æ€
async function checkAuthStatus() {
  try {
    if (api.isLoggedIn()) {
      const response = await api.verifyToken();
      if (response.success) {
        currentUser = response.data.user;
        console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', currentUser);
      } else {
        // Tokenæ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°æ•°æ®
        await api.logout();
        currentUser = null;
      }
    }
  } catch (error) {
    console.error('âŒ æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
    currentUser = null;
  }
  
  renderAuthArea();
}

// æ¸²æŸ“è®¤è¯åŒºåŸŸ
function renderAuthArea() {
  const authArea = document.getElementById('authArea');
  
  if (currentUser) {
    authArea.innerHTML = `
      <div class="user-info">
        <div class="avatar"></div>
        <span>æ¬¢è¿ï¼Œ${currentUser.username}</span>
        <button class="btn secondary" onclick="logout()">é€€å‡º</button>
      </div>
    `;
  } else {
    authArea.innerHTML = `
      <a href="pages/login.html" class="btn secondary">ç™»å½•</a>
      <a href="pages/register.html" class="btn">æ³¨å†Œ</a>
    `;
  }
}

// åŠ è½½ä¹¦è¯„åˆ—è¡¨
async function loadReviews() {
  if (isLoading) return;
  
  isLoading = true;
  showLoading();
  
  try {
    console.log('ğŸ“š æ­£åœ¨åŠ è½½ä¹¦è¯„åˆ—è¡¨...');
    
    // è·å–ä¹¦è¯„åˆ—è¡¨
    const response = await api.request('/reviews?limit=50');
    
    if (response.success) {
      allReviews = response.data.reviews || [];
      console.log(`âœ… åŠ è½½äº† ${allReviews.length} æ¡ä¹¦è¯„`);
      renderReviews(allReviews);
    } else {
      throw new Error(response.message || 'åŠ è½½å¤±è´¥');
    }
    
  } catch (error) {
    console.error('âŒ åŠ è½½ä¹¦è¯„å¤±è´¥:', error);
    showError('åŠ è½½ä¹¦è¯„å¤±è´¥: ' + error.message);
  } finally {
    isLoading = false;
    hideLoading();
  }
}

// æ¸²æŸ“ä¹¦è¯„åˆ—è¡¨
function renderReviews(reviews) {
  const reviewsList = document.getElementById('reviewsList');
  const emptyDiv = document.getElementById('empty');
  
  if (!reviews || reviews.length === 0) {
    reviewsList.innerHTML = '';
    emptyDiv.style.display = 'block';
    return;
  }
  
  emptyDiv.style.display = 'none';
  
  reviewsList.innerHTML = reviews.map(review => `
    <div class="card" onclick="viewReview(${review.id})">
      <h3>${escapeHtml(review.title)}</h3>
      <div class="meta">
        <span>ğŸ“– ${escapeHtml(review.book_title)}</span>
        <span>âœï¸ ${escapeHtml(review.book_author)}</span>
        <span class="badge">${escapeHtml(review.username)}</span>
      </div>
      <div class="rating">
        ${'â­'.repeat(review.rating)} (${review.rating}/5)
      </div>
      <div class="content">
        ${escapeHtml(review.content).substring(0, 150)}${review.content.length > 150 ? '...' : ''}
      </div>
      <div class="stats">
        <span>ğŸ‘ï¸ ${formatNumber(review.views || 0)}</span>
        <span>â¤ï¸ ${formatNumber(review.likes_count || 0)}</span>
        <span>ğŸ’¬ ${formatNumber(review.comments_count || 0)}</span>
        <span>ğŸ“… ${formatDate(review.created_at)}</span>
      </div>
    </div>
  `).join('');
}

// æŸ¥çœ‹ä¹¦è¯„è¯¦æƒ…
function viewReview(reviewId) {
  // è·³è½¬åˆ°ä¹¦è¯„è¯¦æƒ…é¡µé¢
  console.log('æŸ¥çœ‹ä¹¦è¯„:', reviewId);
  window.location.href = `pages/review-detail.html?id=${reviewId}`;
}

// æœç´¢åŠŸèƒ½
function handleSearchKeyPress(event) {
  if (event.key === 'Enter') {
    performSearch();
  }
}

async function performSearch() {
  const query = document.getElementById('searchInput').value.trim();
  
  if (!query) {
    renderReviews(allReviews);
    return;
  }
  
  console.log('ğŸ” æœç´¢:', query);
  
  // æ˜¾ç¤ºæœç´¢çŠ¶æ€
  showLoading();
  
  // æ¨¡æ‹Ÿæœç´¢å»¶è¿Ÿï¼ˆå®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šè°ƒç”¨åç«¯æœç´¢APIï¼‰
  await new Promise(resolve => setTimeout(resolve, 300));
  
  // å‰ç«¯ç®€å•æœç´¢ï¼ˆåç»­å¯ä»¥æ”¹ä¸ºåç«¯æœç´¢ï¼‰
  const filteredReviews = allReviews.filter(review => 
    review.title.toLowerCase().includes(query.toLowerCase()) ||
    review.book_title.toLowerCase().includes(query.toLowerCase()) ||
    review.book_author.toLowerCase().includes(query.toLowerCase()) ||
    review.content.toLowerCase().includes(query.toLowerCase()) ||
    review.username.toLowerCase().includes(query.toLowerCase())
  );
  
  hideLoading();
  renderReviews(filteredReviews);
  
  if (filteredReviews.length === 0) {
    showMessage(`æ²¡æœ‰æ‰¾åˆ°åŒ…å« "${query}" çš„ä¹¦è¯„`, 'error');
  } else {
    showMessage(`æ‰¾åˆ° ${filteredReviews.length} æ¡ç›¸å…³ä¹¦è¯„`);
  }
}

// é€€å‡ºç™»å½•
async function logout() {
  try {
    await api.logout();
    currentUser = null;
    renderAuthArea();
    showMessage('å·²é€€å‡ºç™»å½•');
  } catch (error) {
    console.error('âŒ é€€å‡ºç™»å½•å¤±è´¥:', error);
    showError('é€€å‡ºç™»å½•å¤±è´¥');
  }
}

// å·¥å…·å‡½æ•°
function showLoading() {
  document.getElementById('loading').style.display = 'block';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

function showMessage(message, type = 'success') {
  showToast(message, type);
}

function showError(message) {
  showToast(message, 'error');
}

// Toastæç¤ºåŠŸèƒ½
function showToast(message, type = 'success') {
  // ç§»é™¤ç°æœ‰çš„toast
  const existingToast = document.querySelector('.toast');
  if (existingToast) {
    existingToast.remove();
  }
  
  // åˆ›å»ºæ–°çš„toast
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  
  document.body.appendChild(toast);
  
  // æ˜¾ç¤ºtoast
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  // 3ç§’åè‡ªåŠ¨éšè—
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (toast.parentNode) {
        toast.remove();
      }
    }, 300);
  }, 3000);
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatDate(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const diffTime = Math.abs(now - date);
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) {
    return 'ä»Šå¤©';
  } else if (diffDays === 1) {
    return 'æ˜¨å¤©';
  } else if (diffDays < 7) {
    return `${diffDays}å¤©å‰`;
  } else {
    return date.toLocaleDateString('zh-CN');
  }
}

function formatNumber(num) {
  if (num >= 1000000) {
    return (num / 1000000).toFixed(1) + 'M';
  } else if (num >= 1000) {
    return (num / 1000).toFixed(1) + 'K';
  }
  return num.toString();
}

console.log('ğŸ“š ä¸»é¡µè„šæœ¬åŠ è½½å®Œæˆ');
</script>
</body>
</html>