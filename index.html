<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>书评管理系统 - 首页</title>

<!-- API工具类 -->
<script src="js/api.js"></script>

<style>
*{box-sizing:border-box}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Segoe UI",Roboto,"Noto Sans CJK SC","Microsoft YaHei","Helvetica Neue",Arial}
a{color:#ff6a00;text-decoration:none}
a:hover{text-decoration:underline}
.header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee}
.nav{max-width:1200px;margin:auto;display:flex;align-items:center;gap:20px;padding:12px 16px}
.brand{font-weight:700;color:#ff6a00}
.nav-spacer{flex:1}
.btn{display:inline-block;padding:10px 16px;border:none;border-radius:8px;background:#ff6a00;color:#fff;cursor:pointer;text-decoration:none}
.btn.secondary{background:#eee;color:#333}
.btn:hover{text-decoration:none;opacity:0.9}
.container{max-width:1200px;margin:auto;padding:20px 16px}
.search{display:flex;gap:8px;margin:12px 0 20px}
.search input{flex:1;padding:10px 12px;border:1px solid #ddd;border-radius:8px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}
.card{border:1px solid #eee;border-radius:12px;padding:20px;background:#fff;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(135deg,#ff6a00 0%,#e55a4f 100%);opacity:0;transition:opacity 0.2s}
.card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.1);transform:translateY(-2px)}
.card:hover::before{opacity:1}
.card h3{margin:0 0 8px;font-size:18px;color:#333;line-height:1.3}
.meta{color:#666;font-size:14px;margin-bottom:12px;display:flex;align-items:center;flex-wrap:wrap;gap:8px}
.content{color:#555;line-height:1.5;margin-bottom:12px;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.rating{color:#ff6a00;font-size:16px;margin-bottom:8px;font-weight:600}
.stats{display:flex;gap:15px;font-size:13px;color:#999;flex-wrap:wrap}
.stats span{display:flex;align-items:center;gap:4px;white-space:nowrap}
.badge{display:inline-block;background:#ffe8d9;color:#a34b00;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
.empty{padding:60px 0;text-align:center;color:#999}
.footer{color:#999;font-size:12px;text-align:center;margin:40px 0 20px}
.loading{display:flex;justify-content:center;align-items:center;padding:40px;color:#666}
.loading::after{content:'';width:20px;height:20px;border:2px solid #ff6a00;border-top:2px solid transparent;border-radius:50%;animation:spin 1s linear infinite;margin-left:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.user-info{display:flex;align-items:center;gap:10px}
.avatar{width:32px;height:32px;border-radius:50%;background:#f0f0f0}
.contest-banner{background:linear-gradient(135deg,#ff6a00 0%,#e55a4f 100%);color:#fff;border-radius:12px;padding:20px;margin:20px 0;text-align:center}
.contest-title{font-size:24px;font-weight:bold;margin-bottom:10px}
.contest-subtitle{font-size:16px;margin-bottom:15px;opacity:0.9}
.contest-button{background:rgba(255,255,255,0.2);color:#fff;border:2px solid rgba(255,255,255,0.3);padding:10px 20px;border-radius:25px;cursor:pointer;transition:all 0.3s}
.contest-button:hover{background:rgba(255,255,255,0.3)}

/* Toast提示 */
.toast{position:fixed;top:20px;right:20px;background:#333;color:#fff;padding:12px 20px;border-radius:8px;z-index:1000;opacity:0;transform:translateX(100%);transition:all 0.3s ease}
.toast.show{opacity:1;transform:translateX(0)}
.toast.error{background:#e74c3c}
.toast.success{background:#27ae60}

/* 响应式设计 */
@media (max-width: 768px) {
  .nav{padding:12px;flex-wrap:wrap;gap:12px}
  .brand{font-size:18px}
  .container{padding:16px 12px}
  .grid{grid-template-columns:1fr;gap:16px}
  .card{padding:16px}
  .contest-banner{margin:16px 0;padding:16px}
  .contest-title{font-size:20px}
  .contest-subtitle{font-size:14px}
  .search{flex-direction:column;gap:12px}
  .search input{padding:12px}
  .stats{gap:12px}
  .toast{top:10px;right:10px;left:10px;transform:translateY(-100%)}
  .toast.show{transform:translateY(0)}
}
</style>
</head>
<body>
<header class="header">
  <div class="nav">
    <div class="brand">📚 BookReviewer</div>
    <a href="index.html">首页</a>
    <a href="pages/add-review.html">发布书评</a>
    <div class="nav-spacer"></div>
    <div id="authArea"></div>
  </div>
</header>

<main class="container">
  <!-- 活动横幅 -->
  <div class="contest-banner">
    <div class="contest-title">📖 优秀书评鉴赏文章征集中</div>
    <div class="contest-subtitle">分享你的阅读感悟，赢取精美奖品</div>
    <button class="contest-button" onclick="location.href='pages/add-review.html'">立即参与</button>
  </div>
  
  <div class="search">
    <input id="searchInput" placeholder="搜索书名 / 作者 / 书评标题" onkeypress="handleSearchKeyPress(event)">
    <button class="btn" onclick="performSearch()">搜索</button>
  </div>
  
  <div id="reviewsList" class="grid"></div>
  <div id="loading" class="loading" style="display:none;">加载中...</div>
  <div id="empty" class="empty" style="display:none;">还没有书评，去 <a href="pages/add-review.html">发布一条</a> 试试</div>
  <div class="footer">© 2025 书评管理系统（课程作业演示）</div>
</main>

<script>
// 全局变量
let currentUser = null;
let allReviews = [];
let isLoading = false;

// 页面初始化
document.addEventListener('DOMContentLoaded', async () => {
  console.log('📚 书评管理系统初始化...');
  
  // 检查登录状态
  await checkAuthStatus();
  
  // 加载书评列表
  await loadReviews();
  
  console.log('✅ 页面初始化完成');
});

// 检查认证状态
async function checkAuthStatus() {
  try {
    if (api.isLoggedIn()) {
      const response = await api.verifyToken();
      if (response.success) {
        currentUser = response.data.user;
        console.log('✅ 用户已登录:', currentUser);
      } else {
        // Token无效，清除本地数据
        await api.logout();
        currentUser = null;
      }
    }
  } catch (error) {
    console.error('❌ 检查认证状态失败:', error);
    currentUser = null;
  }
  
  renderAuthArea();
}

// 渲染认证区域
function renderAuthArea() {
  const authArea = document.getElementById('authArea');
  
  if (currentUser) {
    authArea.innerHTML = `
      <div class="user-info">
        <div class="avatar"></div>
        <span>欢迎，${currentUser.username}</span>
        <button class="btn secondary" onclick="logout()">退出</button>
      </div>
    `;
  } else {
    authArea.innerHTML = `
      <a href="pages/login.html" class="btn secondary">登录</a>
      <a href="pages/register.html" class="btn">注册</a>
    `;
  }
}

// 加载书评列表
async function loadReviews() {
  if (isLoading) return;
  
  isLoading = true;
  showLoading();
  
  try {
    console.log('📚 正在加载书评列表...');
    
    // 获取书评列表
    const response = await api.request('/reviews?limit=50');
    
    if (response.success) {
      allReviews = response.data.reviews || [];
      console.log(`✅ 加载了 ${allReviews.length} 条书评`);
      renderReviews(allReviews);
    } else {
      throw new Error(response.message || '加载失败');
    }
    
  } catch (error) {
    console.error('❌ 加载书评失败:', error);
    showError('加载书评失败: ' + error.message);
  } finally {
    isLoading = false;
    hideLoading();
  }
}

// 渲染书评列表
function renderReviews(reviews) {
  const reviewsList = document.getElementById('reviewsList');
  const emptyDiv = document.getElementById('empty');
  
  if (!reviews || reviews.length === 0) {
    reviewsList.innerHTML = '';
    emptyDiv.style.display = 'block';
    return;
  }
  
  emptyDiv.style.display = 'none';
  
  reviewsList.innerHTML = reviews.map(review => `
    <div class="card" onclick="viewReview(${review.id})">
      <h3>${escapeHtml(review.title)}</h3>
      <div class="meta">
        <span>📖 ${escapeHtml(review.book_title)}</span>
        <span>✍️ ${escapeHtml(review.book_author)}</span>
        <span class="badge">${escapeHtml(review.username)}</span>
      </div>
      <div class="rating">
        ${'⭐'.repeat(review.rating)} (${review.rating}/5)
      </div>
      <div class="content">
        ${escapeHtml(review.content).substring(0, 150)}${review.content.length > 150 ? '...' : ''}
      </div>
      <div class="stats">
        <span>👁️ ${formatNumber(review.views || 0)}</span>
        <span>❤️ ${formatNumber(review.likes_count || 0)}</span>
        <span>💬 ${formatNumber(review.comments_count || 0)}</span>
        <span>📅 ${formatDate(review.created_at)}</span>
      </div>
    </div>
  `).join('');
}

// 查看书评详情
function viewReview(reviewId) {
  // 跳转到书评详情页面
  console.log('查看书评:', reviewId);
  window.location.href = `pages/review-detail.html?id=${reviewId}`;
}

// 搜索功能
function handleSearchKeyPress(event) {
  if (event.key === 'Enter') {
    performSearch();
  }
}

async function performSearch() {
  const query = document.getElementById('searchInput').value.trim();
  
  if (!query) {
    renderReviews(allReviews);
    return;
  }
  
  console.log('🔍 搜索:', query);
  
  // 显示搜索状态
  showLoading();
  
  // 模拟搜索延迟（实际项目中这里会调用后端搜索API）
  await new Promise(resolve => setTimeout(resolve, 300));
  
  // 前端简单搜索（后续可以改为后端搜索）
  const filteredReviews = allReviews.filter(review => 
    review.title.toLowerCase().includes(query.toLowerCase()) ||
    review.book_title.toLowerCase().includes(query.toLowerCase()) ||
    review.book_author.toLowerCase().includes(query.toLowerCase()) ||
    review.content.toLowerCase().includes(query.toLowerCase()) ||
    review.username.toLowerCase().includes(query.toLowerCase())
  );
  
  hideLoading();
  renderReviews(filteredReviews);
  
  if (filteredReviews.length === 0) {
    showMessage(`没有找到包含 "${query}" 的书评`, 'error');
  } else {
    showMessage(`找到 ${filteredReviews.length} 条相关书评`);
  }
}

// 退出登录
async function logout() {
  try {
    await api.logout();
    currentUser = null;
    renderAuthArea();
    showMessage('已退出登录');
  } catch (error) {
    console.error('❌ 退出登录失败:', error);
    showError('退出登录失败');
  }
}

// 工具函数
function showLoading() {
  document.getElementById('loading').style.display = 'block';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

function showMessage(message, type = 'success') {
  showToast(message, type);
}

function showError(message) {
  showToast(message, 'error');
}

// Toast提示功能
function showToast(message, type = 'success') {
  // 移除现有的toast
  const existingToast = document.querySelector('.toast');
  if (existingToast) {
    existingToast.remove();
  }
  
  // 创建新的toast
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  
  document.body.appendChild(toast);
  
  // 显示toast
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  // 3秒后自动隐藏
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (toast.parentNode) {
        toast.remove();
      }
    }, 300);
  }, 3000);
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatDate(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const diffTime = Math.abs(now - date);
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) {
    return '今天';
  } else if (diffDays === 1) {
    return '昨天';
  } else if (diffDays < 7) {
    return `${diffDays}天前`;
  } else {
    return date.toLocaleDateString('zh-CN');
  }
}

function formatNumber(num) {
  if (num >= 1000000) {
    return (num / 1000000).toFixed(1) + 'M';
  } else if (num >= 1000) {
    return (num / 1000).toFixed(1) + 'K';
  }
  return num.toString();
}

console.log('📚 主页脚本加载完成');
</script>
</body>
</html>