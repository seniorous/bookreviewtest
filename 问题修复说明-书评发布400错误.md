# ğŸ› é—®é¢˜ä¿®å¤è¯´æ˜ - ä¹¦è¯„å‘å¸ƒ 400 é”™è¯¯

## ğŸ“‹ é—®é¢˜æè¿°

**ç—‡çŠ¶**ï¼š
- ç”¨æˆ·å¡«å†™ä¹¦è¯„è¡¨å•åç‚¹å‡»"å‘å¸ƒä¹¦è¯„"
- è¯·æ±‚å¤±è´¥ï¼Œè¿”å› 400 Bad Request
- æ²¡æœ‰è¯¦ç»†çš„é”™è¯¯æç¤º

**æ—¥å¿—è¡¨ç°**ï¼š
```
ğŸ“¡ [2025/10/15 15:12:59] POST /api/books - ::1
ğŸ” ç”¨æˆ·è®¤è¯æˆåŠŸ: seniorous (1254762865@qq.com)
ğŸ”´ [2025/10/15 15:12:59] POST /api/books - 400 (12ms)
```

---

## ğŸ” é—®é¢˜æ ¹å› 

### **å­—æ®µå‘½åä¸åŒ¹é…**

**å‰ç«¯å‘é€çš„æ•°æ®**ï¼ˆ`pages/add-review.html` ç¬¬ 386-390 è¡Œï¼‰ï¼š
```javascript
{
  title: formData.bookTitle,
  author: formData.bookAuthor,
  isbn: formData.isbn,
  publisher: formData.publisher,
  publishYear: formData.publishYear  // âŒ é©¼å³°å‘½å
}
```

**åç«¯éªŒè¯æœŸæœ›çš„å­—æ®µ**ï¼ˆ`backend/middleware/validate.js` ç¬¬ 128 è¡Œï¼‰ï¼š
```javascript
{
  title: ...,
  author: ...,
  isbn: ...,
  publisher: ...,
  publish_year: ...,  // âœ… ä¸‹åˆ’çº¿å‘½åï¼ˆæ•°æ®åº“é£æ ¼ï¼‰
  cover_url: ...      // âŒ å‰ç«¯æ²¡æœ‰å‘é€è¿™ä¸ªå­—æ®µ
}
```

### **é—®é¢˜åˆ†æ**

1. **å‘½åé£æ ¼ä¸ç»Ÿä¸€**
   - å‰ç«¯ä½¿ç”¨ `publishYear`ï¼ˆJavaScript é©¼å³°å‘½åï¼‰
   - åç«¯æœŸæœ› `publish_year`ï¼ˆæ•°æ®åº“ä¸‹åˆ’çº¿å‘½åï¼‰

2. **ç¼ºå°‘å¿…éœ€å­—æ®µ**
   - åç«¯éªŒè¯è§„åˆ™ä¸­è™½ç„¶ `cover_url` è®¾ç½®ä¸ºå¯é€‰ï¼ˆ`.allow('', null)`ï¼‰
   - ä½†å‰ç«¯å®Œå…¨æ²¡æœ‰å‘é€è¿™ä¸ªå­—æ®µ

3. **é”™è¯¯ä¿¡æ¯ä¸æ˜ç¡®**
   - Celebrate éªŒè¯å¤±è´¥åç›´æ¥è¿”å› 400
   - æ²¡æœ‰åœ¨åç«¯æ—¥å¿—ä¸­è¾“å‡ºè¯¦ç»†çš„éªŒè¯é”™è¯¯ä¿¡æ¯

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### **ä¿®å¤ 1ï¼šç»Ÿä¸€å­—æ®µå‘½å**

**æ–‡ä»¶**ï¼š`pages/add-review.html`

**ä¿®æ”¹å‰**ï¼š
```javascript
body: JSON.stringify({
  title: formData.bookTitle,
  author: formData.bookAuthor,
  isbn: formData.isbn,
  publisher: formData.publisher,
  publishYear: formData.publishYear  // âŒ é”™è¯¯
})
```

**ä¿®æ”¹å**ï¼š
```javascript
body: JSON.stringify({
  title: formData.bookTitle,
  author: formData.bookAuthor,
  isbn: formData.isbn || '',
  publisher: formData.publisher || '',
  publish_year: formData.publishYear,  // âœ… æ”¹ä¸ºä¸‹åˆ’çº¿å‘½å
  cover_url: ''  // âœ… æ·»åŠ å°é¢URLå­—æ®µ
})
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… å­—æ®µåæ”¹ä¸º `publish_year`ï¼ˆä¸åç«¯ä¸€è‡´ï¼‰
- âœ… æ·»åŠ  `cover_url` å­—æ®µï¼ˆè®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼‰
- âœ… ç©ºå€¼å­—æ®µä½¿ç”¨ `|| ''` ç¡®ä¿å‘é€ç©ºå­—ç¬¦ä¸²è€Œä¸æ˜¯ `undefined`

---

### **ä¿®å¤ 2ï¼šå¢å¼ºé”™è¯¯æ—¥å¿—**

**æ–‡ä»¶**ï¼š`backend/server.js`

**æ·»åŠ çš„ä»£ç **ï¼š
```javascript
const { errors: celebrateErrors, isCelebrateError } = require('celebrate');

// è‡ªå®šä¹‰ celebrate é”™è¯¯æ—¥å¿—ä¸­é—´ä»¶
app.use((err, req, res, next) => {
  if (isCelebrateError(err)) {
    console.log(`âŒ è¯·æ±‚éªŒè¯å¤±è´¥: ${req.method} ${req.originalUrl}`);
    
    // æå–éªŒè¯é”™è¯¯è¯¦æƒ…
    const errorDetails = {};
    for (const [segment, joiError] of err.details.entries()) {
      errorDetails[segment] = joiError.details.map(detail => ({
        field: detail.path.join('.'),
        message: detail.message,
        type: detail.type
      }));
    }
    
    console.log('ğŸ“‹ éªŒè¯é”™è¯¯è¯¦æƒ…:', JSON.stringify(errorDetails, null, 2));
  }
  next(err);
});

app.use(celebrateErrors());
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… æ•è· Celebrate éªŒè¯é”™è¯¯
- âœ… åœ¨æ§åˆ¶å°è¾“å‡ºè¯¦ç»†çš„éªŒè¯å¤±è´¥ä¿¡æ¯
- âœ… åŒ…å«é”™è¯¯å­—æ®µã€é”™è¯¯æ¶ˆæ¯ã€é”™è¯¯ç±»å‹

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹**ï¼š
```
âŒ è¯·æ±‚éªŒè¯å¤±è´¥: POST /api/books
ğŸ“‹ éªŒè¯é”™è¯¯è¯¦æƒ…: {
  "body": [
    {
      "field": "publish_year",
      "message": "\"publishYear\" is not allowed",
      "type": "object.unknown"
    }
  ]
}
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### **æµ‹è¯•æ­¥éª¤**

1. **åˆ·æ–°æµè§ˆå™¨é¡µé¢**
   ```
   è®¿é—®ï¼šhttp://localhost:8080/pages/add-review.html
   æŒ‰ Ctrl + F5 å¼ºåˆ¶åˆ·æ–°ï¼ˆæ¸…é™¤ç¼“å­˜ï¼‰
   ```

2. **å¡«å†™è¡¨å•**
   - ä¹¦åï¼šã€Šæµ‹è¯•ä¹¦ç±ã€‹
   - ä½œè€…ï¼šæµ‹è¯•ä½œè€…
   - ISBNï¼šï¼ˆå¯é€‰ï¼‰
   - å‡ºç‰ˆç¤¾ï¼šï¼ˆå¯é€‰ï¼‰
   - å‡ºç‰ˆå¹´ä»½ï¼š2024
   - ä¹¦è¯„æ ‡é¢˜ï¼šæµ‹è¯•ä¹¦è¯„
   - è¯„åˆ†ï¼šâ­â­â­â­â­ï¼ˆ5æ˜Ÿï¼‰
   - ä¹¦è¯„å†…å®¹ï¼šè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å†…å®¹...

3. **ç‚¹å‡»å‘å¸ƒ**

4. **æŸ¥çœ‹åç«¯æ—¥å¿—**
   ```
   å¦‚æœä¿®å¤æˆåŠŸï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   ğŸ“¡ [æ—¶é—´] POST /api/books - ::1
   ğŸ” ç”¨æˆ·è®¤è¯æˆåŠŸ: seniorous (...)
   ğŸŸ¢ [æ—¶é—´] POST /api/books - 201 (XXms)  â† æˆåŠŸï¼
   
   ğŸ“¡ [æ—¶é—´] POST /api/reviews - ::1
   ğŸŸ¢ [æ—¶é—´] POST /api/reviews - 201 (XXms)  â† æˆåŠŸï¼
   ```

5. **éªŒè¯ç»“æœ**
   - âœ… é¡µé¢æ˜¾ç¤º"ä¹¦è¯„å‘å¸ƒæˆåŠŸï¼"
   - âœ… 2ç§’åè‡ªåŠ¨è·³è½¬åˆ°é¦–é¡µ
   - âœ… é¦–é¡µèƒ½çœ‹åˆ°åˆšå‘å¸ƒçš„ä¹¦è¯„

---

## ğŸ“š ç»éªŒæ€»ç»“

### **1. å‘½åè§„èŒƒç»Ÿä¸€**

**é—®é¢˜**ï¼š
- å‰ç«¯ JavaScript ä¹ æƒ¯ç”¨é©¼å³°å‘½åï¼ˆ`publishYear`ï¼‰
- åç«¯æ•°æ®åº“ä¹ æƒ¯ç”¨ä¸‹åˆ’çº¿å‘½åï¼ˆ`publish_year`ï¼‰
- ä¸¤è€…ä¸ç»Ÿä¸€å¯¼è‡´æ•°æ®ä¼ é€’å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **æ–¹æ¡ˆ A**ï¼šå‰ç«¯å‘é€æ—¶è½¬æ¢ä¸ºä¸‹åˆ’çº¿å‘½åï¼ˆæœ¬æ¬¡é‡‡ç”¨ï¼‰
- **æ–¹æ¡ˆ B**ï¼šåç«¯æ¥æ”¶åè½¬æ¢ä¸ºé©¼å³°å‘½å
- **æ–¹æ¡ˆ C**ï¼šåœ¨ API å±‚ç»Ÿä¸€åšå­—æ®µè½¬æ¢

**æœ€ä½³å®è·µ**ï¼š
```javascript
// å‰ç«¯ç»Ÿä¸€è½¬æ¢å‡½æ•°
function toSnakeCase(obj) {
  const result = {};
  for (const [key, value] of Object.entries(obj)) {
    const snakeKey = key.replace(/([A-Z])/g, '_$1').toLowerCase();
    result[snakeKey] = value;
  }
  return result;
}

// ä½¿ç”¨
const data = toSnakeCase({
  publishYear: 2024,
  coverUrl: 'xxx'
});
// ç»“æœ: { publish_year: 2024, cover_url: 'xxx' }
```

---

### **2. éªŒè¯é”™è¯¯å¤„ç†**

**é—®é¢˜**ï¼š
- Celebrate éªŒè¯å¤±è´¥ååªè¿”å› 400
- å‰ç«¯ç”¨æˆ·çœ‹ä¸åˆ°å…·ä½“å“ªä¸ªå­—æ®µé”™è¯¯
- åç«¯æ—¥å¿—ä¹Ÿæ²¡æœ‰è¯¦ç»†ä¿¡æ¯

**æ”¹è¿›**ï¼š
- âœ… åç«¯æ·»åŠ éªŒè¯é”™è¯¯æ—¥å¿—ä¸­é—´ä»¶
- âœ… å‰ç«¯å¯ä»¥è¿›ä¸€æ­¥è§£æé”™è¯¯å“åº”æ˜¾ç¤ºå‹å¥½æç¤º

**è¿›ä¸€æ­¥ä¼˜åŒ–**ï¼ˆå¯é€‰ï¼‰ï¼š
```javascript
// å‰ç«¯ API é”™è¯¯å¤„ç†
async function handleApiError(response) {
  const data = await response.json();
  
  if (response.status === 400 && data.validation) {
    // æ˜¾ç¤ºå…·ä½“çš„å­—æ®µé”™è¯¯
    const errors = data.validation.body.details.map(d => d.message);
    showMessage(`è¾“å…¥é”™è¯¯ï¼š${errors.join(', ')}`, 'error');
  } else {
    showMessage(data.message || 'è¯·æ±‚å¤±è´¥', 'error');
  }
}
```

---

### **3. è°ƒè¯•æŠ€å·§**

**å¿«é€Ÿå®šä½é—®é¢˜**ï¼š
1. âœ… æŸ¥çœ‹æµè§ˆå™¨ Network é¢æ¿
   - Request Payloadï¼ˆæŸ¥çœ‹å‘é€çš„æ•°æ®ï¼‰
   - Responseï¼ˆæŸ¥çœ‹è¿”å›çš„é”™è¯¯ä¿¡æ¯ï¼‰

2. âœ… æŸ¥çœ‹åç«¯æ—¥å¿—
   - ç°åœ¨ä¼šè¾“å‡ºè¯¦ç»†çš„éªŒè¯é”™è¯¯

3. âœ… ä½¿ç”¨ Postman/Thunder æµ‹è¯•
   ```json
   POST http://localhost:3001/api/books
   Headers: Authorization: Bearer <token>
   Body: {
     "title": "æµ‹è¯•",
     "author": "ä½œè€…",
     "publish_year": 2024,
     "cover_url": ""
   }
   ```

---

## ğŸ¯ é¢„é˜²æªæ–½

### **1. ä½¿ç”¨ TypeScript**
å®šä¹‰ç»Ÿä¸€çš„æ¥å£ç±»å‹ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥å­—æ®µåï¼š
```typescript
interface CreateBookRequest {
  title: string;
  author: string;
  publish_year?: number;
  cover_url?: string;
}
```

### **2. ä½¿ç”¨ API æ–‡æ¡£å·¥å…·**
å¦‚ Swagger/OpenAPIï¼Œè‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£ï¼Œå‰åç«¯å¯¹ç…§ï¼š
```yaml
CreateBookRequest:
  type: object
  required:
    - title
    - author
  properties:
    title:
      type: string
    author:
      type: string
    publish_year:
      type: integer
      nullable: true
    cover_url:
      type: string
      nullable: true
```

### **3. ç¼–å†™å•å…ƒæµ‹è¯•**
```javascript
describe('POST /api/books', () => {
  it('åº”è¯¥åˆ›å»ºä¹¦ç±ï¼ˆå®Œæ•´å­—æ®µï¼‰', async () => {
    const response = await request(app)
      .post('/api/books')
      .send({
        title: 'æµ‹è¯•ä¹¦ç±',
        author: 'æµ‹è¯•ä½œè€…',
        publish_year: 2024,
        cover_url: ''
      });
    
    expect(response.status).toBe(201);
  });
  
  it('åº”è¯¥æ‹’ç»é”™è¯¯çš„å­—æ®µå', async () => {
    const response = await request(app)
      .post('/api/books')
      .send({
        title: 'æµ‹è¯•ä¹¦ç±',
        author: 'æµ‹è¯•ä½œè€…',
        publishYear: 2024  // é”™è¯¯çš„å­—æ®µå
      });
    
    expect(response.status).toBe(400);
  });
});
```

---

## âœ… ä¿®å¤å®Œæˆ

- âœ… ä¿®å¤å­—æ®µå‘½åä¸åŒ¹é…é—®é¢˜
- âœ… æ·»åŠ è¯¦ç»†çš„éªŒè¯é”™è¯¯æ—¥å¿—
- âœ… æä¾›å®Œæ•´çš„æµ‹è¯•æ­¥éª¤
- âœ… æ€»ç»“ç»éªŒå’Œé¢„é˜²æªæ–½

**ç°åœ¨å¯ä»¥æ­£å¸¸å‘å¸ƒä¹¦è¯„äº†ï¼** ğŸ‰

