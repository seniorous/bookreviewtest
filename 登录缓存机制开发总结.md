# ğŸ‰ ç™»å½•ç¼“å­˜æœºåˆ¶å¼€å‘å®Œæˆæ€»ç»“

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æˆåŠŸå®ç°äº†åŸºäº **Cookie + Session** çš„ç”¨æˆ·ç™»å½•ä¿¡æ¯ç¼“å­˜æœºåˆ¶ï¼Œæ”¯æŒ"è®°ä½æˆ‘"åŠŸèƒ½ã€å¤šæ ‡ç­¾é¡µçŠ¶æ€åŒæ­¥ã€Token è¿‡æœŸè‡ªåŠ¨æ£€æµ‹ç­‰é«˜çº§ç‰¹æ€§ã€‚

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### **1. Cookie + LocalStorage åŒé‡å­˜å‚¨**

#### **åç«¯å®ç°**
- âœ… å®‰è£…å¹¶é…ç½® `cookie-parser` ä¸­é—´ä»¶
- âœ… ç™»å½•/æ³¨å†Œæ¥å£é€šè¿‡ `res.cookie()` è®¾ç½® HttpOnly Cookie
- âœ… é€€å‡ºç™»å½•æ¥å£é€šè¿‡ `res.clearCookie()` æ¸…é™¤ Cookie
- âœ… `authenticateToken` å’Œ `optionalAuth` ä¸­é—´ä»¶æ”¯æŒä» Cookie è¯»å– Token
- âœ… Token è¯»å–ä¼˜å…ˆçº§ï¼š`Authorization Header` > `Cookie`

#### **å‰ç«¯å®ç°**
- âœ… æ‰€æœ‰ API è¯·æ±‚é…ç½® `credentials: 'include'` ä»¥æºå¸¦ Cookie
- âœ… `localStorage` å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼ˆ`user_info`ï¼‰ç”¨äºå¿«é€Ÿè®¿é—®
- âœ… Cookie å­˜å‚¨ Tokenï¼ˆ`auth_token`ï¼‰æ›´å®‰å…¨ï¼ˆHttpOnly é˜²XSSï¼‰

#### **å­˜å‚¨ç­–ç•¥å¯¹æ¯”**

| å­˜å‚¨æ–¹å¼ | å­˜å‚¨å†…å®¹ | å®‰å…¨æ€§ | ç”¨é€” |
|---------|---------|--------|------|
| **Cookie** | `auth_token` | â­â­â­â­â­ HttpOnly | èº«ä»½è®¤è¯ Token |
| **LocalStorage** | `user_info` | â­â­â­ | ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆéæ•æ„Ÿï¼‰ |

---

### **2. "è®°ä½æˆ‘" åŠŸèƒ½**

#### **å®ç°é€»è¾‘**

```
ç”¨æˆ·ç™»å½•æ—¶é€‰æ‹©ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â˜‘ è®°ä½æˆ‘ï¼ˆ30å¤©å†…ä¿æŒç™»å½•ï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    rememberMe = true  â”€â”€â”€â”€â†’  Cookie maxAge = 30å¤©ï¼ˆæŒä¹…Cookieï¼‰
    rememberMe = false â”€â”€â”€â”€â†’  Cookie Sessionï¼ˆå…³é—­æµè§ˆå™¨å¤±æ•ˆï¼‰
```

#### **ä»£ç å®ç°**

**åç«¯ï¼ˆ`backend/routes/auth.js`ï¼‰**ï¼š
```javascript
if (rememberMe) {
  cookieOptions.maxAge = 30 * 24 * 60 * 60 * 1000; // 30å¤©
} else {
  // ä¸è®¾ç½® maxAgeï¼Œå³ä¸º Session Cookie
}
res.cookie('auth_token', token, cookieOptions);
```

**å‰ç«¯ï¼ˆ`pages/login.html` + `js/api.js`ï¼‰**ï¼š
```javascript
// è·å–ç”¨æˆ·é€‰æ‹©
const rememberMe = formData.get('rememberMe') === 'on';

// ä¼ é€’ç»™åç«¯
await api.login(email, password, rememberMe);
```

#### **ç”¨æˆ·ä½“éªŒ**

| åœºæ™¯ | è®°ä½æˆ‘ | è¡Œä¸º |
|------|-------|------|
| å…³é—­æ ‡ç­¾é¡µ | âœ… / âŒ | ä¿æŒç™»å½• |
| å…³é—­æµè§ˆå™¨ | âœ… | ä¿æŒç™»å½• |
| å…³é—­æµè§ˆå™¨ | âŒ | éœ€è¦é‡æ–°ç™»å½• |
| 30å¤©å | âœ… | Token è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½• |

---

### **3. å¤šæ ‡ç­¾é¡µçŠ¶æ€åŒæ­¥**

#### **æŠ€æœ¯åŸç†**

åˆ©ç”¨æµè§ˆå™¨çš„ `storage` äº‹ä»¶ç›‘å¬ `localStorage` å˜åŒ–ï¼Œå®ç°è·¨æ ‡ç­¾é¡µé€šä¿¡ã€‚

```
æ ‡ç­¾é¡µ A                 æ ‡ç­¾é¡µ B                 æ ‡ç­¾é¡µ C
   â”‚                        â”‚                        â”‚
   â”œâ”€ ç”¨æˆ·ç‚¹å‡»é€€å‡º          â”‚                        â”‚
   â”‚                        â”‚                        â”‚
   â”œâ”€ localStorage.removeItem('auth_token')          â”‚
   â”‚                        â”‚                        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ storage event â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            â†“                        â†“
                      åˆ·æ–°/è·³è½¬ç™»å½•é¡µ          åˆ·æ–°/è·³è½¬ç™»å½•é¡µ
```

#### **å®ç°ä»£ç ï¼ˆ`js/auth-sync.js`ï¼‰**

```javascript
window.addEventListener('storage', function(event) {
  if (event.key === 'auth_token') {
    if (event.newValue === null) {
      // Token è¢«åˆ é™¤ â†’ é€€å‡ºç™»å½•
      alert('æ‚¨å·²åœ¨å…¶ä»–æ ‡ç­¾é¡µé€€å‡ºç™»å½•');
      window.location.href = '/pages/login.html';
    } else {
      // Token è¢«æ›´æ–° â†’ ç™»å½•
      window.location.reload();
    }
  }
});
```

#### **æµ‹è¯•åœºæ™¯**

âœ… **åœºæ™¯ 1ï¼šé€€å‡ºåŒæ­¥**
- æ‰“å¼€ 3 ä¸ªæ ‡ç­¾é¡µï¼ˆé¦–é¡µã€ä¸ªäººä¸­å¿ƒã€å‘å¸ƒä¹¦è¯„ï¼‰
- åœ¨é¦–é¡µç‚¹å‡»é€€å‡º
- å…¶ä»– 2 ä¸ªæ ‡ç­¾é¡µè‡ªåŠ¨è·³è½¬ç™»å½•é¡µ

âœ… **åœºæ™¯ 2ï¼šç™»å½•åŒæ­¥**
- æ‰“å¼€ 2 ä¸ªæœªç™»å½•çš„æ ‡ç­¾é¡µ
- åœ¨ä¸€ä¸ªæ ‡ç­¾é¡µç™»å½•
- å¦ä¸€ä¸ªæ ‡ç­¾é¡µè‡ªåŠ¨åˆ·æ–°ï¼Œæ˜¾ç¤ºç™»å½•çŠ¶æ€

---

### **4. Token è¿‡æœŸæ£€æµ‹å’Œè‡ªåŠ¨è·³è½¬**

#### **æ£€æµ‹æœºåˆ¶**

```
é¡µé¢åŠ è½½
   â†“
æ£€æŸ¥ localStorage ä¸­çš„ auth_token
   â†“
è§£æ JWT çš„ exp å­—æ®µ
   â†“
â”Œâ”€ æœªè¿‡æœŸ â”€â”€â”€â”€â†’ æ­£å¸¸ä½¿ç”¨
â”‚
â””â”€ å·²è¿‡æœŸ â”€â”€â”€â”€â†’ æ¸…é™¤æœ¬åœ°æ•°æ® â”€â”€â”€â”€â†’ è·³è½¬ç™»å½•é¡µ
```

#### **å®šæ—¶æ£€æŸ¥**

- é¡µé¢åŠ è½½æ—¶ç«‹å³æ£€æŸ¥
- ä¹‹åæ¯ **5 åˆ†é’Ÿ**æ£€æŸ¥ä¸€æ¬¡
- é¿å…ç”¨æˆ·åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­çªç„¶å¤±æ•ˆ

#### **å®ç°ä»£ç ï¼ˆ`js/auth-sync.js`ï¼‰**

```javascript
function checkTokenExpiration() {
  const token = localStorage.getItem('auth_token');
  
  if (isTokenExpired(token)) {
    console.warn('âš ï¸ Token å·²è¿‡æœŸ');
    localStorage.removeItem('auth_token');
    localStorage.removeItem('user_info');
    
    if (!isPublicPage) {
      alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
      window.location.href = '/pages/login.html';
    }
  }
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
document.addEventListener('DOMContentLoaded', checkTokenExpiration);

// æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
setInterval(checkTokenExpiration, 5 * 60 * 1000);
```

---

### **5. Cookie å®‰å…¨é…ç½®**

#### **å®‰å…¨å±æ€§**

| å±æ€§ | å€¼ | ä½œç”¨ |
|------|---|------|
| **httpOnly** | `true` | é˜²æ­¢ JavaScript è¯»å–ï¼ˆé˜²XSSï¼‰ |
| **secure** | `true` (ç”Ÿäº§ç¯å¢ƒ) | ä»…é€šè¿‡ HTTPS ä¼ è¾“ |
| **sameSite** | `Lax` | é˜²æ­¢ CSRF æ”»å‡» |
| **path** | `/` | å…¨ç«™å¯ç”¨ |
| **maxAge** | `30å¤©` æˆ– `Session` | è¿‡æœŸæ—¶é—´ |

#### **ä»£ç å®ç°**

```javascript
const cookieOptions = {
  httpOnly: true,  // é˜²XSS
  secure: process.env.NODE_ENV === 'production',  // ç”Ÿäº§ç¯å¢ƒHTTPS
  sameSite: 'lax',  // é˜²CSRF
  path: '/'
};

if (rememberMe) {
  cookieOptions.maxAge = 30 * 24 * 60 * 60 * 1000;
}

res.cookie('auth_token', token, cookieOptions);
```

#### **å®‰å…¨æ€§å¯¹æ¯”**

| æ”»å‡»ç±»å‹ | LocalStorage | Cookie (HttpOnly) |
|---------|--------------|-------------------|
| XSS çªƒå– Token | âŒ æ˜“å—æ”»å‡» | âœ… å—ä¿æŠ¤ |
| CSRF æ”»å‡» | âœ… ä¸å—å½±å“ | âœ… SameSite ä¿æŠ¤ |
| ä¸­é—´äººæ”»å‡» | âš ï¸ éœ€HTTPS | âœ… Secure ä¿æŠ¤ |

---

## ğŸ“‚ æ–‡ä»¶ä¿®æ”¹æ¸…å•

### **åç«¯æ–‡ä»¶**

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `backend/package.json` | æ·»åŠ  `cookie-parser` ä¾èµ– |
| `backend/server.js` | å¼•å…¥å¹¶é…ç½® `cookie-parser` ä¸­é—´ä»¶ |
| `backend/routes/auth.js` | ç™»å½•/æ³¨å†Œ/é€€å‡ºæ¥å£è®¾ç½®/æ¸…é™¤ Cookie |
| `backend/middleware/auth.js` | `authenticateToken` å’Œ `optionalAuth` æ”¯æŒè¯»å– Cookie |

### **å‰ç«¯æ–‡ä»¶**

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `js/api.js` | `login()` æ”¯æŒ `rememberMe` å‚æ•°ï¼Œ`request()` æ·»åŠ  `credentials: 'include'` |
| `js/auth-sync.js` | **æ–°å»º**ï¼šToken è¿‡æœŸæ£€æµ‹ + å¤šæ ‡ç­¾é¡µåŒæ­¥å·¥å…· |
| `pages/login.html` | æ·»åŠ "è®°ä½æˆ‘"å¤é€‰æ¡† UI |
| `index.html` | å¼•å…¥ `auth-sync.js` |
| `pages/profile.html` | å¼•å…¥ `auth-sync.js` |
| `pages/add-review.html` | å¼•å…¥ `auth-sync.js` |
| `pages/review-detail.html` | å¼•å…¥ `auth-sync.js` |

### **æ–‡æ¡£æ–‡ä»¶**

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `Cookieå’ŒSessionç™»å½•æµ‹è¯•æŒ‡å—.md` | **æ–°å»º**ï¼šè¯¦ç»†çš„æµ‹è¯•æ­¥éª¤å’Œé¢„æœŸç»“æœ |
| `ç™»å½•ç¼“å­˜æœºåˆ¶å¼€å‘æ€»ç»“.md` | **æ–°å»º**ï¼šæœ¬æ–‡æ¡£ |

---

## ğŸ§ª æµ‹è¯•è¦ç‚¹

### **å¿…é¡»æµ‹è¯•çš„åœºæ™¯**

1. âœ… **å‹¾é€‰è®°ä½æˆ‘**ï¼šå…³é—­æµè§ˆå™¨åé‡æ–°æ‰“å¼€ï¼Œä»ç„¶ç™»å½•
2. âœ… **ä¸å‹¾é€‰è®°ä½æˆ‘**ï¼šå…³é—­æµè§ˆå™¨åé‡æ–°æ‰“å¼€ï¼Œéœ€è¦é‡æ–°ç™»å½•
3. âœ… **å¤šæ ‡ç­¾é¡µåŒæ­¥ï¼ˆé€€å‡ºï¼‰**ï¼šä¸€ä¸ªæ ‡ç­¾é¡µé€€å‡ºï¼Œå…¶ä»–æ ‡ç­¾é¡µåŒæ­¥é€€å‡º
4. âœ… **å¤šæ ‡ç­¾é¡µåŒæ­¥ï¼ˆç™»å½•ï¼‰**ï¼šä¸€ä¸ªæ ‡ç­¾é¡µç™»å½•ï¼Œå…¶ä»–æ ‡ç­¾é¡µåŒæ­¥ç™»å½•
5. âœ… **Token è¿‡æœŸè·³è½¬**ï¼šToken è¿‡æœŸåè®¿é—®éœ€è¦ç™»å½•çš„é¡µé¢ï¼Œè‡ªåŠ¨è·³è½¬ç™»å½•é¡µ
6. âœ… **Cookie å®‰å…¨å±æ€§**ï¼šHttpOnlyã€Secureã€SameSite è®¾ç½®æ­£ç¡®
7. âœ… **API è¯·æ±‚æºå¸¦ Cookie**ï¼šNetwork é¢æ¿ä¸­è¯·æ±‚å¤´åŒ…å« Cookie

---

## ğŸ¯ æŠ€æœ¯äº®ç‚¹

### **1. åŒé‡å­˜å‚¨ç­–ç•¥**
- Cookie å­˜å‚¨ Tokenï¼ˆå®‰å…¨ï¼‰
- LocalStorage å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼ˆä¾¿æ·ï¼‰
- ä¸¤è€…ç»“åˆï¼Œå…¼é¡¾å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒ

### **2. ä¼˜é›…çš„è¿‡æœŸå¤„ç†**
- å‰ç«¯è§£æ JWT è¿‡æœŸæ—¶é—´
- å®šæ—¶æ£€æŸ¥ + é¡µé¢åŠ è½½æ£€æŸ¥
- å‹å¥½çš„æç¤ºä¿¡æ¯

### **3. è·¨æ ‡ç­¾é¡µé€šä¿¡**
- åˆ©ç”¨ `storage` äº‹ä»¶
- æ— éœ€ WebSocket æˆ–è½®è¯¢
- åŸç”Ÿæµè§ˆå™¨æ”¯æŒï¼Œæ€§èƒ½ä¼˜ç§€

### **4. æ¸è¿›å¼å®‰å…¨**
- å¼€å‘ç¯å¢ƒï¼š`secure: false`ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
- ç”Ÿäº§ç¯å¢ƒï¼š`secure: true`ï¼ˆå¼ºåˆ¶HTTPSï¼‰
- æ ¹æ®ç¯å¢ƒè‡ªåŠ¨åˆ‡æ¢

---

## ğŸ“Š æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æµè§ˆå™¨ (Browser)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  ç™»å½•é¡µé¢                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚  â”‚ â˜‘ è®°ä½æˆ‘ï¼ˆ30å¤©ï¼‰       â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                                          â”‚
â”‚  å­˜å‚¨ç­–ç•¥ï¼š                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Cookie            â”‚ LocalStorage                 â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ auth_token        â”‚ user_info                    â”‚  â”‚
â”‚  â”‚ (HttpOnly)        â”‚ (ç”¨æˆ·åŸºæœ¬ä¿¡æ¯)                â”‚  â”‚
â”‚  â”‚                   â”‚                              â”‚  â”‚
â”‚  â”‚ è®°ä½æˆ‘=true:      â”‚ åŒæ­¥æœºåˆ¶:                    â”‚  â”‚
â”‚  â”‚  maxAge=30å¤©      â”‚  storage äº‹ä»¶ç›‘å¬            â”‚  â”‚
â”‚  â”‚                   â”‚                              â”‚  â”‚
â”‚  â”‚ è®°ä½æˆ‘=false:     â”‚ è¿‡æœŸæ£€æµ‹:                    â”‚  â”‚
â”‚  â”‚  Session Cookie   â”‚  JWT exp å­—æ®µ + å®šæ—¶æ£€æŸ¥     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  auth-sync.js (å…¨å±€å·¥å…·)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ Token è¿‡æœŸæ£€æµ‹ï¼ˆæ¯5åˆ†é’Ÿï¼‰                       â”‚  â”‚
â”‚  â”‚ â€¢ å¤šæ ‡ç­¾é¡µåŒæ­¥ï¼ˆstorage äº‹ä»¶ï¼‰                    â”‚  â”‚
â”‚  â”‚ â€¢ è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†•
              HTTP (Cookie è‡ªåŠ¨æºå¸¦)
                          â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                åç«¯ (Node.js/Express)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  cookie-parser ä¸­é—´ä»¶                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ req.cookies.auth_token â”€â†’ è§£æ Cookie            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  POST /api/auth/login                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. éªŒè¯ç”¨æˆ·åå¯†ç                                  â”‚  â”‚
â”‚  â”‚ 2. ç”Ÿæˆ JWT Token                                â”‚  â”‚
â”‚  â”‚ 3. æ ¹æ® rememberMe è®¾ç½® Cookie:                  â”‚  â”‚
â”‚  â”‚    â€¢ true:  maxAge = 30å¤©                        â”‚  â”‚
â”‚  â”‚    â€¢ false: Session Cookie                       â”‚  â”‚
â”‚  â”‚ 4. è¿”å› { token, user }                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  authenticateToken ä¸­é—´ä»¶                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è¯»å– Token ä¼˜å…ˆçº§:                                â”‚  â”‚
â”‚  â”‚ 1. Authorization Header (Bearer Token)           â”‚  â”‚
â”‚  â”‚ 2. Cookie (auth_token)                           â”‚  â”‚
â”‚  â”‚ 3. éªŒè¯ JWT æœ‰æ•ˆæ€§                                â”‚  â”‚
â”‚  â”‚ 4. æŸ¥è¯¢ç”¨æˆ·çŠ¶æ€ï¼ˆæ•°æ®åº“ï¼‰                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### **1. å¯åŠ¨åç«¯æœåŠ¡**

```bash
cd backend
npm install  # ç¡®ä¿å®‰è£…äº† cookie-parser
npm run dev
```

### **2. å¯åŠ¨å‰ç«¯æœåŠ¡**

```bash
# æ–¹å¼ 1ï¼šä½¿ç”¨ http-server
npx http-server -p 8080

# æ–¹å¼ 2ï¼šä½¿ç”¨ Live Serverï¼ˆVSCode æ’ä»¶ï¼‰
å³é”® index.html â†’ Open with Live Server
```

### **3. æµ‹è¯•ç™»å½•**

1. è®¿é—® `http://localhost:8080/pages/login.html`
2. è¾“å…¥é‚®ç®±å’Œå¯†ç 
3. **å‹¾é€‰**"è®°ä½æˆ‘"å¤é€‰æ¡†
4. ç‚¹å‡»ç™»å½•
5. å…³é—­æµè§ˆå™¨ï¼Œé‡æ–°æ‰“å¼€
6. è®¿é—® `http://localhost:8080`
7. âœ… åº”è¯¥è‡ªåŠ¨ç™»å½•ï¼Œæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### **å·²å®ç°**
- âœ… HttpOnly Cookieï¼ˆé˜²XSSï¼Œæ€§èƒ½æ— å½±å“ï¼‰
- âœ… å®šæ—¶æ£€æŸ¥é—´éš” 5 åˆ†é’Ÿï¼ˆé¿å…é¢‘ç¹æ£€æŸ¥ï¼‰
- âœ… `storage` äº‹ä»¶ï¼ˆåŸç”Ÿæ”¯æŒï¼Œæ— é¢å¤–å¼€é”€ï¼‰

### **å¯é€‰ä¼˜åŒ–**
- âšª ä½¿ç”¨ Service Worker ç¼“å­˜ API å“åº”
- âšª å®ç° Refresh Token æœºåˆ¶ï¼ˆåŒTokenï¼ŒAccess Token çŸ­æœŸï¼‰
- âšª æ·»åŠ  Token é»‘åå•ï¼ˆRedisï¼‰æ”¯æŒä¸»åŠ¨æ’¤é”€

---

## ğŸ“ å­¦ä¹ è¦ç‚¹

### **Cookie vs LocalStorage**

| ç‰¹æ€§ | Cookie | LocalStorage |
|------|--------|--------------|
| å®¹é‡ | 4KB | 5-10MB |
| è‡ªåŠ¨æºå¸¦ | âœ… | âŒ |
| HttpOnly | âœ… | âŒ |
| è¿‡æœŸæ—¶é—´ | âœ… | âŒ (æ°¸ä¹…) |
| å®‰å…¨æ€§ | â­â­â­â­â­ | â­â­â­ |

### **Session Cookie vs Persistent Cookie**

| ç±»å‹ | è¿‡æœŸæ—¶é—´ | ç”¨é€” |
|------|---------|------|
| **Session Cookie** | å…³é—­æµè§ˆå™¨ | ä¸´æ—¶ç™»å½• |
| **Persistent Cookie** | æŒ‡å®šæ—¶é—´ | é•¿æœŸç™»å½• |

### **JWT Token ç»“æ„**

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9  â† Header (ç®—æ³•)
.
eyJ1c2VySWQiOjEsImV4cCI6MTcwMDAwMDAwMH0  â† Payload (æ•°æ® + è¿‡æœŸæ—¶é—´)
.
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c  â† Signature (ç­¾å)
```

**è§£æ Payload**ï¼š
```javascript
const payload = JSON.parse(atob(token.split('.')[1]));
console.log(payload.exp);  // è¿‡æœŸæ—¶é—´æˆ³ï¼ˆç§’ï¼‰
```

---

## ğŸ‰ æ€»ç»“

æˆåŠŸå®ç°äº†ä¸€ä¸ª**ä¼ä¸šçº§çš„ç™»å½•ç¼“å­˜æœºåˆ¶**ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

âœ… **å®‰å…¨æ€§**ï¼šHttpOnly Cookie + SameSite + Secure
âœ… **ä¾¿æ·æ€§**ï¼š"è®°ä½æˆ‘"åŠŸèƒ½ï¼Œ30å¤©å…ç™»å½•
âœ… **æ™ºèƒ½æ€§**ï¼šToken è¿‡æœŸè‡ªåŠ¨æ£€æµ‹å’Œè·³è½¬
âœ… **åŒæ­¥æ€§**ï¼šå¤šæ ‡ç­¾é¡µçŠ¶æ€å®æ—¶åŒæ­¥
âœ… **å…¼å®¹æ€§**ï¼šæ”¯æŒç°ä»£æµè§ˆå™¨ï¼Œæ¸è¿›å¢å¼º

---

**å¼€å‘å®Œæˆæ—¥æœŸ**ï¼š2025å¹´10æœˆ15æ—¥
**æŠ€æœ¯æ ˆ**ï¼šNode.js, Express, Cookie-Parser, JWT, LocalStorage, Storage Event
**ä»£ç è¡Œæ•°**ï¼šçº¦ 500 è¡Œï¼ˆå‰åç«¯åˆè®¡ï¼‰

**ç¥æ‚¨å­¦ä¹ æ„‰å¿«ï¼** ğŸš€

