<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å‘å¸ƒä¹¦è¯„ - ä¹¦è¯„ç®¡ç†ç³»ç»Ÿ</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
*{box-sizing:border-box}body{margin:0;background:#fafafa;font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Noto Sans",Arial}
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 16px}
.container{max-width:900px;margin:20px auto;padding:0 16px}
h2{margin:6px 0 16px}
.row{display:flex;gap:10px}
.input{flex:1;display:flex;align-items:center;border:1px solid #ddd;border-radius:8px;padding:10px 12px;margin-bottom:12px;background:#fff}
.input input,.input textarea,.input select{border:none;outline:none;flex:1;font-size:14px}
textarea{min-height:140px;resize:vertical}
.btn{padding:12px 16px;border:none;border-radius:8px;background:#ff6a00;color:#fff;cursor:pointer}
.btn:disabled{background:#ccc;cursor:not-allowed}
.markdown-hint{font-size:12px;color:#666;margin-top:4px;line-height:1.4}
</style>
</head>
<body>
  <div class="header"><a href="../index.html">â† è¿”å›</a></div>
  <main class="container">
    <h2>å‘å¸ƒä¹¦è¯„</h2>
    <form id="form">
      <div class="row">
        <div class="input"><span>ğŸ“–&nbsp;</span><input name="title" placeholder="ä¹¦å" required></div>
        <div class="input"><span>âœï¸&nbsp;</span><input name="author" placeholder="ä½œè€…" required></div>
      </div>
      <div class="row">
        <div class="input"><span>â­&nbsp;</span>
          <select name="rating" required>
            <option value="5">5 - å¼ºçƒˆæ¨è</option>
            <option value="4">4 - æ¨è</option>
            <option value="3">3 - ä¸€èˆ¬</option>
            <option value="2">2 - ä¸å¤ªæ¨è</option>
            <option value="1">1 - ä¸æ¨è</option>
          </select>
        </div>
        <div class="input"><span>ğŸ“&nbsp;</span><input name="rvTitle" placeholder="ä¹¦è¯„æ ‡é¢˜" required></div>
      </div>
      <div>
        <div class="input">
          <textarea name="content" placeholder="ä¹¦è¯„æ­£æ–‡ï¼ˆæ”¯æŒMarkdownæ ¼å¼ï¼‰â€¦â€¦&#10;ç¤ºä¾‹ï¼š&#10;**ç²—ä½“** *æ–œä½“*&#10;> å¼•ç”¨&#10;- åˆ—è¡¨é¡¹" required></textarea>
        </div>
        <div class="markdown-hint">
          ğŸ’¡ æ”¯æŒMarkdownè¯­æ³•ï¼š**ç²—ä½“**ã€*æ–œä½“*ã€`ä»£ç `ã€> å¼•ç”¨ã€# æ ‡é¢˜ã€- åˆ—è¡¨ç­‰
        </div>
      </div>
      <button class="btn" type="submit" id="submitBtn">æäº¤</button>
    </form>
  </main>

<script>
// åˆå§‹åŒ–Firebase
firebase.initializeApp(CONFIG.firebase);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;

// æ£€æŸ¥ç™»å½•çŠ¶æ€
auth.onAuthStateChanged((user) => {
  currentUser = user;
  if (!user) {
    alert('è¯·å…ˆç™»å½•');
    location.href = 'login.html';
  }
});

// æŸ¥æ‰¾æˆ–åˆ›å»ºä¹¦ç±
async function findOrCreateBook(title, author) {
  try {
    // æŸ¥æ‰¾ç°æœ‰ä¹¦ç±
    const booksSnapshot = await db.collection('books')
      .where('title', '==', title)
      .where('author', '==', author)
      .get();
    
    if (!booksSnapshot.empty) {
      return booksSnapshot.docs[0].id;
    }
    
    // åˆ›å»ºæ–°ä¹¦ç±
    const bookRef = await db.collection('books').add({
      title,
      author,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return bookRef.id;
  } catch (error) {
    console.error('æŸ¥æ‰¾æˆ–åˆ›å»ºä¹¦ç±å¤±è´¥:', error);
    throw error;
  }
}

// è¡¨å•æäº¤å¤„ç†
document.getElementById('form').onsubmit = async (e) => {
  e.preventDefault();
  
  if (!currentUser) {
    alert('è¯·å…ˆç™»å½•');
    return;
  }
  
  const submitBtn = document.getElementById('submitBtn');
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData.entries());
  
  try {
    // ç¦ç”¨æäº¤æŒ‰é’®
    submitBtn.disabled = true;
    submitBtn.textContent = 'æäº¤ä¸­...';
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºä¹¦ç±
    const bookId = await findOrCreateBook(data.title, data.author);
    
    // åˆ›å»ºä¹¦è¯„
    await db.collection('reviews').add({
      bookId: bookId,
      userId: currentUser.uid,
      title: data.rvTitle,
      content: data.content,
      rating: Number(data.rating),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    alert('å‘å¸ƒæˆåŠŸï¼');
    location.href = '../index.html';
  } catch (error) {
    console.error('å‘å¸ƒå¤±è´¥:', error);
    alert('å‘å¸ƒå¤±è´¥ï¼š' + error.message);
  } finally {
    // æ¢å¤æäº¤æŒ‰é’®
    submitBtn.disabled = false;
    submitBtn.textContent = 'æäº¤';
  }
};
</script>
</body>
</html>