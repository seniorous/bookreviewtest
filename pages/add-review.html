<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å‘å¸ƒä¹¦è¯„ - ä¹¦è¯„ç®¡ç†ç³»ç»Ÿ</title>

<!-- APIå·¥å…· -->
<script src="../js/api.js"></script>

<style>
*{box-sizing:border-box}body{margin:0;background:#fafafa;font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Noto Sans",Arial}
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 16px;z-index:10}
.header a{color:#ff6a00;text-decoration:none}
.container{max-width:800px;margin:20px auto;padding:0 16px}
.card{background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
h2{margin:0 0 24px;color:#333}
.form-group{margin-bottom:20px}
label{display:block;margin-bottom:6px;font-weight:500;color:#333}
.input{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;transition:border-color 0.2s}
.input:focus{outline:none;border-color:#ff6a00}
textarea.input{min-height:120px;resize:vertical;font-family:inherit}
select.input{cursor:pointer}
.rating-group{display:flex;gap:8px;align-items:center}
.star{font-size:24px;color:#ddd;cursor:pointer;transition:color 0.2s}
.star.active{color:#ff6a00}
.star:hover{color:#ff6a00}
.btn{padding:12px 24px;border:none;border-radius:8px;background:#ff6a00;color:#fff;cursor:pointer;font-size:16px;transition:all 0.2s}
.btn:hover:not(:disabled){background:#e55a4f;transform:translateY(-1px)}
.btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
.btn.secondary{background:#6c757d}
.btn.secondary:hover:not(:disabled){background:#5a6268}
.form-actions{display:flex;gap:12px;margin-top:24px}
.loading{text-align:center;padding:20px;color:#666}
.error{background:#fee;border:1px solid #fcc;color:#c33;padding:12px;border-radius:8px;margin-bottom:16px}
.success{background:#efe;border:1px solid #cfc;color:#363;padding:12px;border-radius:8px;margin-bottom:16px}
.book-search{position:relative}
.book-suggestions{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-top:none;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:100}
.book-suggestion{padding:12px;cursor:pointer;border-bottom:1px solid #eee}
.book-suggestion:hover{background:#f8f9fa}
.book-suggestion:last-child{border-bottom:none}
.help-text{font-size:12px;color:#666;margin-top:4px}
</style>
</head>
<body>
  <div class="header">
    <a href="../index.html">â† è¿”å›é¦–é¡µ</a>
  </div>
  
  <main class="container">
    <div class="card">
    <h2>å‘å¸ƒä¹¦è¯„</h2>
      
      <div id="message"></div>
      
      <form id="reviewForm">
        <!-- ä¹¦ç±ä¿¡æ¯ -->
        <div class="form-group">
          <label for="bookTitle">ä¹¦ç±åç§° *</label>
          <div class="book-search">
            <input type="text" id="bookTitle" class="input" placeholder="è¯·è¾“å…¥ä¹¦å" required>
            <div id="bookSuggestions" class="book-suggestions" style="display:none;"></div>
          </div>
          <div class="help-text">è¾“å…¥ä¹¦åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æœç´¢åŒ¹é…çš„ä¹¦ç±</div>
        </div>
        
        <div class="form-group">
          <label for="bookAuthor">ä½œè€… *</label>
          <input type="text" id="bookAuthor" class="input" placeholder="è¯·è¾“å…¥ä½œè€…å§“å" required>
        </div>
        
        <div class="form-group">
          <label for="isbn">ISBNï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" id="isbn" class="input" placeholder="è¯·è¾“å…¥ISBNå·ç ">
        </div>
        
        <div class="form-group">
          <label for="publisher">å‡ºç‰ˆç¤¾ï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" id="publisher" class="input" placeholder="è¯·è¾“å…¥å‡ºç‰ˆç¤¾">
        </div>
        
        <div class="form-group">
          <label for="publishYear">å‡ºç‰ˆå¹´ä»½ï¼ˆå¯é€‰ï¼‰</label>
          <input type="number" id="publishYear" class="input" placeholder="å¦‚ï¼š2023" min="1900" max="2030">
        </div>
        
        <!-- ä¹¦è¯„ä¿¡æ¯ -->
        <div class="form-group">
          <label for="reviewTitle">ä¹¦è¯„æ ‡é¢˜ *</label>
          <input type="text" id="reviewTitle" class="input" placeholder="è¯·è¾“å…¥ä¹¦è¯„æ ‡é¢˜" required>
        </div>
        
        <div class="form-group">
          <label for="rating">è¯„åˆ† *</label>
          <div class="rating-group">
            <span class="star" data-rating="1">â­</span>
            <span class="star" data-rating="2">â­</span>
            <span class="star" data-rating="3">â­</span>
            <span class="star" data-rating="4">â­</span>
            <span class="star" data-rating="5">â­</span>
            <span id="ratingText" style="margin-left:10px;color:#666;">è¯·é€‰æ‹©è¯„åˆ†</span>
          </div>
      </div>
        
        <div class="form-group">
          <label for="content">ä¹¦è¯„å†…å®¹ *</label>
          <textarea id="content" class="input" placeholder="åˆ†äº«æ‚¨çš„è¯»ä¹¦æ„Ÿå—å’Œè§è§£..." required></textarea>
          <div class="help-text">è‡³å°‘10å­—ï¼Œæœ€å¤š5000å­—</div>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn" id="submitBtn">å‘å¸ƒä¹¦è¯„</button>
          <button type="button" class="btn secondary" onclick="resetForm()">é‡ç½®</button>
      </div>
    </form>
    </div>
  </main>

<script>
// å…¨å±€å˜é‡
let currentRating = 0;
let selectedBookId = null;
let isSubmitting = false;

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async () => {
  console.log('ğŸ“ ä¹¦è¯„å‘å¸ƒé¡µé¢åˆå§‹åŒ–...');
  
  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  if (!api.isLoggedIn()) {
    showMessage('è¯·å…ˆç™»å½•åå†å‘å¸ƒä¹¦è¯„', 'error');
    setTimeout(() => {
      window.location.href = 'login.html';
    }, 2000);
    return;
  }
  
  // åˆå§‹åŒ–è¯„åˆ†ç³»ç»Ÿ
  initRatingSystem();
  
  // åˆå§‹åŒ–ä¹¦ç±æœç´¢
  initBookSearch();
  
  // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
  document.getElementById('reviewForm').addEventListener('submit', handleSubmit);
  
  console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
});

// åˆå§‹åŒ–è¯„åˆ†ç³»ç»Ÿ
function initRatingSystem() {
  const stars = document.querySelectorAll('.star');
  const ratingText = document.getElementById('ratingText');
  
  stars.forEach((star, index) => {
    star.addEventListener('click', () => {
      currentRating = index + 1;
      updateStars();
      updateRatingText();
    });
    
    star.addEventListener('mouseover', () => {
      const hoverRating = index + 1;
      updateStarsHover(hoverRating);
    });
  });
  
  document.querySelector('.rating-group').addEventListener('mouseleave', () => {
    updateStars();
  });
}

function updateStars() {
  const stars = document.querySelectorAll('.star');
  stars.forEach((star, index) => {
    star.classList.toggle('active', index < currentRating);
  });
}

function updateStarsHover(hoverRating) {
  const stars = document.querySelectorAll('.star');
  stars.forEach((star, index) => {
    star.style.color = index < hoverRating ? '#ff6a00' : '#ddd';
  });
}

function updateRatingText() {
  const ratingText = document.getElementById('ratingText');
  const texts = ['', 'å¾ˆå·®', 'ä¸€èˆ¬', 'ä¸é”™', 'å¾ˆå¥½', 'æä½³'];
  ratingText.textContent = `${currentRating}/5 - ${texts[currentRating]}`;
}

// åˆå§‹åŒ–ä¹¦ç±æœç´¢
function initBookSearch() {
  const bookTitleInput = document.getElementById('bookTitle');
  const suggestionsDiv = document.getElementById('bookSuggestions');
  
  let searchTimeout;
  
  bookTitleInput.addEventListener('input', (e) => {
    const query = e.target.value.trim();
    
    clearTimeout(searchTimeout);
    
    if (query.length < 2) {
      hideSuggestions();
      return;
    }
    
    searchTimeout = setTimeout(() => {
      searchBooks(query);
    }, 300);
  });
  
  // ç‚¹å‡»å¤–éƒ¨å…³é—­å»ºè®®
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.book-search')) {
      hideSuggestions();
    }
  });
}

// æœç´¢ä¹¦ç±
async function searchBooks(query) {
  try {
    console.log('ğŸ” æœç´¢ä¹¦ç±:', query);
    
    const response = await api.request(`/books?search=${encodeURIComponent(query)}&limit=5`);
    
    if (response.success && response.data.books.length > 0) {
      showBookSuggestions(response.data.books);
    } else {
      hideSuggestions();
    }
    
  } catch (error) {
    console.error('âŒ æœç´¢ä¹¦ç±å¤±è´¥:', error);
    hideSuggestions();
  }
}

// æ˜¾ç¤ºä¹¦ç±å»ºè®®
function showBookSuggestions(books) {
  const suggestionsDiv = document.getElementById('bookSuggestions');
  
  suggestionsDiv.innerHTML = books.map(book => `
    <div class="book-suggestion" onclick="selectBook(${book.id}, '${escapeHtml(book.title)}', '${escapeHtml(book.author)}')">
      <div><strong>${escapeHtml(book.title)}</strong></div>
      <div style="font-size:12px;color:#666;">${escapeHtml(book.author)} ${book.publish_year ? '(' + book.publish_year + ')' : ''}</div>
    </div>
  `).join('');
  
  suggestionsDiv.style.display = 'block';
}

// éšè—ä¹¦ç±å»ºè®®
function hideSuggestions() {
  document.getElementById('bookSuggestions').style.display = 'none';
}

// é€‰æ‹©ä¹¦ç±
function selectBook(bookId, title, author) {
  selectedBookId = bookId;
  document.getElementById('bookTitle').value = title;
  document.getElementById('bookAuthor').value = author;
  hideSuggestions();
  
  console.log('âœ… é€‰æ‹©ä¹¦ç±:', { bookId, title, author });
}

// å¤„ç†è¡¨å•æäº¤
async function handleSubmit(e) {
  e.preventDefault();
  
  if (isSubmitting) return;
  
  // éªŒè¯è¡¨å•
  if (!validateForm()) {
    return;
  }
  
  isSubmitting = true;
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'å‘å¸ƒä¸­...';
  
  try {
    // æ”¶é›†è¡¨å•æ•°æ®
    const formData = collectFormData();
    
    console.log('ğŸ“ æäº¤ä¹¦è¯„æ•°æ®:', formData);
    
    // å¦‚æœæ²¡æœ‰é€‰æ‹©ç°æœ‰ä¹¦ç±ï¼Œå…ˆåˆ›å»ºä¹¦ç±
    let bookId = selectedBookId;
    if (!bookId) {
      const bookResponse = await api.request('/books', {
        method: 'POST',
        body: JSON.stringify({
          title: formData.bookTitle,
          author: formData.bookAuthor,
          isbn: formData.isbn,
          publisher: formData.publisher,
          publishYear: formData.publishYear
        })
      });
      
      if (bookResponse.success) {
        bookId = bookResponse.data.book.id;
        console.log('âœ… åˆ›å»ºä¹¦ç±æˆåŠŸ:', bookId);
      } else {
        throw new Error(bookResponse.message || 'åˆ›å»ºä¹¦ç±å¤±è´¥');
      }
    }
    
    // åˆ›å»ºä¹¦è¯„
    const reviewResponse = await api.request('/reviews', {
      method: 'POST',
      body: JSON.stringify({
        book_id: bookId,
        title: formData.reviewTitle,
        content: formData.content,
        rating: formData.rating
      })
    });
    
    if (reviewResponse.success) {
      showMessage('ä¹¦è¯„å‘å¸ƒæˆåŠŸï¼', 'success');
      
      // 2ç§’åè·³è½¬åˆ°é¦–é¡µ
      setTimeout(() => {
        window.location.href = '../index.html';
      }, 2000);
      
    } else {
      throw new Error(reviewResponse.message || 'å‘å¸ƒä¹¦è¯„å¤±è´¥');
    }
    
  } catch (error) {
    console.error('âŒ å‘å¸ƒä¹¦è¯„å¤±è´¥:', error);
    showMessage('å‘å¸ƒå¤±è´¥: ' + error.message, 'error');
  } finally {
    isSubmitting = false;
    submitBtn.disabled = false;
    submitBtn.textContent = 'å‘å¸ƒä¹¦è¯„';
  }
}

// éªŒè¯è¡¨å•
function validateForm() {
  const bookTitle = document.getElementById('bookTitle').value.trim();
  const bookAuthor = document.getElementById('bookAuthor').value.trim();
  const reviewTitle = document.getElementById('reviewTitle').value.trim();
  const content = document.getElementById('content').value.trim();
  
  if (!bookTitle) {
    showMessage('è¯·è¾“å…¥ä¹¦ç±åç§°', 'error');
    return false;
  }
  
  if (!bookAuthor) {
    showMessage('è¯·è¾“å…¥ä½œè€…å§“å', 'error');
    return false;
  }
  
  if (!reviewTitle) {
    showMessage('è¯·è¾“å…¥ä¹¦è¯„æ ‡é¢˜', 'error');
    return false;
  }
  
  if (!content) {
    showMessage('è¯·è¾“å…¥ä¹¦è¯„å†…å®¹', 'error');
    return false;
  }
  
  if (content.length < 10) {
    showMessage('ä¹¦è¯„å†…å®¹è‡³å°‘éœ€è¦100å­—', 'error');
    return false;
  }
  
  if (content.length > 5000) {
    showMessage('ä¹¦è¯„å†…å®¹ä¸èƒ½è¶…è¿‡5000å­—', 'error');
    return false;
  }
  
  if (currentRating === 0) {
    showMessage('è¯·é€‰æ‹©è¯„åˆ†', 'error');
    return false;
  }
  
  return true;
}

// æ”¶é›†è¡¨å•æ•°æ®
function collectFormData() {
  return {
    bookTitle: document.getElementById('bookTitle').value.trim(),
    bookAuthor: document.getElementById('bookAuthor').value.trim(),
    isbn: document.getElementById('isbn').value.trim(),
    publisher: document.getElementById('publisher').value.trim(),
    publishYear: document.getElementById('publishYear').value ? parseInt(document.getElementById('publishYear').value) : null,
    reviewTitle: document.getElementById('reviewTitle').value.trim(),
    content: document.getElementById('content').value.trim(),
    rating: currentRating
  };
}

// é‡ç½®è¡¨å•
function resetForm() {
  document.getElementById('reviewForm').reset();
  currentRating = 0;
  selectedBookId = null;
  updateStars();
  document.getElementById('ratingText').textContent = 'è¯·é€‰æ‹©è¯„åˆ†';
  hideSuggestions();
  clearMessage();
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(message, type = 'info') {
  const messageDiv = document.getElementById('message');
  messageDiv.className = type;
  messageDiv.textContent = message;
  messageDiv.style.display = 'block';
  
  // 3ç§’åè‡ªåŠ¨éšè—ï¼ˆé™¤äº†æˆåŠŸæ¶ˆæ¯ï¼‰
  if (type !== 'success') {
    setTimeout(() => {
      clearMessage();
    }, 3000);
  }
}

// æ¸…é™¤æ¶ˆæ¯
function clearMessage() {
  const messageDiv = document.getElementById('message');
  messageDiv.style.display = 'none';
  messageDiv.textContent = '';
  messageDiv.className = '';
}

// å·¥å…·å‡½æ•°
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

console.log('ğŸ“ ä¹¦è¯„å‘å¸ƒé¡µé¢è„šæœ¬åŠ è½½å®Œæˆ');
</script>
</body>
</html>