<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>发布书评 - 书评管理系统</title>

<!-- API工具 -->
<script src="../js/api.js"></script>
<!-- 认证同步工具 -->
<script src="../js/auth-sync.js"></script>

<!-- Markdown 渲染库 -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

<style>
*{box-sizing:border-box}body{margin:0;background:#fafafa;font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Noto Sans",Arial}
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 16px;z-index:10}
.header a{color:#ff6a00;text-decoration:none}
.container{max-width:800px;margin:20px auto;padding:0 16px}
.card{background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
h2{margin:0 0 24px;color:#333}
.form-group{margin-bottom:20px}
label{display:block;margin-bottom:6px;font-weight:500;color:#333}
.input{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;transition:border-color 0.2s}
.input:focus{outline:none;border-color:#ff6a00}
textarea.input{min-height:120px;resize:vertical;font-family:inherit}
select.input{cursor:pointer}
.rating-group{display:flex;gap:8px;align-items:center}
.star{font-size:24px;color:#ddd;cursor:pointer;transition:color 0.2s}
.star.active{color:#ff6a00}
.star:hover{color:#ff6a00}
.btn{padding:12px 24px;border:none;border-radius:8px;background:#ff6a00;color:#fff;cursor:pointer;font-size:16px;transition:all 0.2s}
.btn:hover:not(:disabled){background:#e55a4f;transform:translateY(-1px)}
.btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
.btn.secondary{background:#6c757d}
.btn.secondary:hover:not(:disabled){background:#5a6268}
.form-actions{display:flex;gap:12px;margin-top:24px}
.loading{text-align:center;padding:20px;color:#666}
.error{background:#fee;border:1px solid #fcc;color:#c33;padding:12px;border-radius:8px;margin-bottom:16px}
.success{background:#efe;border:1px solid #cfc;color:#363;padding:12px;border-radius:8px;margin-bottom:16px}
.book-search{position:relative}
.book-suggestions{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-top:none;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:100}
.book-suggestion{padding:12px;cursor:pointer;border-bottom:1px solid #eee}
.book-suggestion:hover{background:#f8f9fa}
.book-suggestion:last-child{border-bottom:none}
.help-text{font-size:12px;color:#666;margin-top:4px}

/* Markdown 编辑器样式 */
.editor-container{display:flex;gap:16px;margin-bottom:20px}
.editor-panel{flex:1;min-width:0}
.editor-panel.preview{background:#f8f9fa;padding:16px;border-radius:8px;border:1px solid #ddd;max-height:500px;overflow-y:auto}
.panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.panel-title{font-size:14px;font-weight:600;color:#333}
.toggle-preview{font-size:12px;color:#ff6a00;cursor:pointer;text-decoration:none}
.toggle-preview:hover{text-decoration:underline}
.markdown-toolbar{display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap}
.md-btn{padding:6px 10px;background:#fff;border:1px solid #ddd;border-radius:4px;cursor:pointer;font-size:12px;transition:all 0.2s}
.md-btn:hover{background:#f0f0f0;border-color:#ccc}
.char-counter{font-size:12px;color:#999;text-align:right;margin-top:4px}

/* Markdown 预览样式 */
.markdown-preview h1,.markdown-preview h2,.markdown-preview h3{margin:16px 0 8px;font-weight:600}
.markdown-preview h1{font-size:22px;border-bottom:2px solid #eee;padding-bottom:6px}
.markdown-preview h2{font-size:18px}
.markdown-preview h3{font-size:16px}
.markdown-preview p{margin:10px 0;line-height:1.6}
.markdown-preview ul,.markdown-preview ol{margin:10px 0;padding-left:20px}
.markdown-preview li{margin:4px 0}
.markdown-preview blockquote{margin:12px 0;padding:10px 14px;border-left:4px solid #ff6a00;background:#fff;color:#666}
.markdown-preview code{background:#f4f4f4;padding:2px 5px;border-radius:3px;font-family:monospace;font-size:13px}
.markdown-preview pre{background:#f4f4f4;padding:10px;border-radius:5px;overflow-x:auto;margin:10px 0}
.markdown-preview pre code{background:none;padding:0}
.markdown-preview a{color:#ff6a00;text-decoration:underline}
.markdown-preview img{max-width:100%;height:auto;border-radius:6px;margin:10px 0}
.markdown-preview table{border-collapse:collapse;width:100%;margin:10px 0}
.markdown-preview th,.markdown-preview td{border:1px solid #ddd;padding:8px;text-align:left}
.markdown-preview th{background:#f8f9fa;font-weight:600}

@media (max-width:768px){
  .editor-container{flex-direction:column}
  .editor-panel.preview{max-height:300px}
}
</style>
</head>
<body>
  <div class="header">
    <a href="../index.html">← 返回首页</a>
  </div>
  
  <main class="container">
    <div class="card">
    <h2>发布书评</h2>
      
      <div id="message"></div>
      
      <form id="reviewForm">
        <!-- 书籍信息 -->
        <div class="form-group">
          <label for="bookTitle">书籍名称 *</label>
          <div class="book-search">
            <input type="text" id="bookTitle" class="input" placeholder="请输入书名" required>
            <div id="bookSuggestions" class="book-suggestions" style="display:none;"></div>
          </div>
          <div class="help-text">输入书名，系统会自动搜索匹配的书籍</div>
        </div>
        
        <div class="form-group">
          <label for="bookAuthor">作者 *</label>
          <input type="text" id="bookAuthor" class="input" placeholder="请输入作者姓名" required>
        </div>
        
        <div class="form-group">
          <label for="isbn">ISBN（可选）</label>
          <input type="text" id="isbn" class="input" placeholder="请输入ISBN号码">
        </div>
        
        <div class="form-group">
          <label for="publisher">出版社（可选）</label>
          <input type="text" id="publisher" class="input" placeholder="请输入出版社">
        </div>
        
        <div class="form-group">
          <label for="publishYear">出版年份（可选）</label>
          <input type="number" id="publishYear" class="input" placeholder="如：2023" min="1900" max="2030">
        </div>
        
        <!-- 书评信息 -->
        <div class="form-group">
          <label for="reviewTitle">书评标题 *</label>
          <input type="text" id="reviewTitle" class="input" placeholder="请输入书评标题" required>
        </div>
        
        <div class="form-group">
          <label for="rating">评分 *</label>
          <div class="rating-group">
            <span class="star" data-rating="1">⭐</span>
            <span class="star" data-rating="2">⭐</span>
            <span class="star" data-rating="3">⭐</span>
            <span class="star" data-rating="4">⭐</span>
            <span class="star" data-rating="5">⭐</span>
            <span id="ratingText" style="margin-left:10px;color:#666;">请选择评分</span>
          </div>
      </div>
        
        <div class="form-group">
          <label>书评内容 * <span class="help-text">(支持 Markdown 格式)</span></label>
          
          <div class="editor-container">
            <!-- 编辑区 -->
            <div class="editor-panel">
              <div class="panel-header">
                <span class="panel-title">📝 编辑</span>
                <a class="toggle-preview" onclick="togglePreview()">👁️ 切换预览</a>
              </div>
              
              <!-- Markdown 工具栏 -->
              <div class="markdown-toolbar">
                <button type="button" class="md-btn" onclick="insertMarkdown('**', '**')" title="粗体">B</button>
                <button type="button" class="md-btn" onclick="insertMarkdown('*', '*')" title="斜体">I</button>
                <button type="button" class="md-btn" onclick="insertMarkdown('# ', '')" title="标题">#</button>
                <button type="button" class="md-btn" onclick="insertMarkdown('> ', '')" title="引用">❝</button>
                <button type="button" class="md-btn" onclick="insertMarkdown('- ', '')" title="列表">•</button>
                <button type="button" class="md-btn" onclick="insertMarkdown('`', '`')" title="代码">&lt;/&gt;</button>
                <button type="button" class="md-btn" onclick="insertMarkdown('[链接文字](', ')')" title="链接">🔗</button>
              </div>
              
              <textarea 
                id="content" 
                class="input" 
                placeholder="# 主标题&#10;&#10;## 副标题&#10;&#10;分享您的读书感受和见解...&#10;&#10;**提示**：支持 Markdown 语法，可以使用标题、列表、引用、代码等格式。"
                required
                oninput="updatePreview(); updateCharCount();"
                style="min-height:300px;font-family:monospace;font-size:14px;line-height:1.6;"
              ></textarea>
              <div class="char-counter">
                <span id="charCount">0</span> / 5000 字
              </div>
            </div>
            
            <!-- 预览区 -->
            <div class="editor-panel preview" id="previewPanel">
              <div class="panel-header">
                <span class="panel-title">👁️ 预览</span>
              </div>
              <div id="markdownPreview" class="markdown-preview">
                <p style="color:#999;text-align:center;padding:40px 0;">在左侧输入内容，这里会实时显示渲染效果...</p>
              </div>
            </div>
          </div>
          
          <div class="help-text">
            💡 至少10字，最多5000字 | 
            <a href="https://www.markdownguide.org/basic-syntax/" target="_blank" style="color:#ff6a00;">Markdown 语法指南</a>
      </div>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn" id="submitBtn">发布书评</button>
          <button type="button" class="btn secondary" onclick="resetForm()">重置</button>
      </div>
    </form>
    </div>
  </main>

<script>
// 全局变量
let currentRating = 0;
let selectedBookId = null;
let isSubmitting = false;

// 页面初始化
document.addEventListener('DOMContentLoaded', async () => {
  console.log('📝 书评发布页面初始化...');
  
  // 检查登录状态
  if (!api.isLoggedIn()) {
    showMessage('请先登录后再发布书评', 'error');
    setTimeout(() => {
      window.location.href = 'login.html';
    }, 2000);
    return;
  }
  
  // 初始化评分系统
  initRatingSystem();
  
  // 初始化书籍搜索
  initBookSearch();
  
  // 绑定表单提交事件
  document.getElementById('reviewForm').addEventListener('submit', handleSubmit);
  
  console.log('✅ 页面初始化完成');
});

// 初始化评分系统
function initRatingSystem() {
  const stars = document.querySelectorAll('.star');
  const ratingText = document.getElementById('ratingText');
  
  stars.forEach((star, index) => {
    star.addEventListener('click', () => {
      currentRating = index + 1;
      updateStars();
      updateRatingText();
    });
    
    star.addEventListener('mouseover', () => {
      const hoverRating = index + 1;
      updateStarsHover(hoverRating);
    });
  });
  
  document.querySelector('.rating-group').addEventListener('mouseleave', () => {
    updateStars();
  });
}

function updateStars() {
  const stars = document.querySelectorAll('.star');
  stars.forEach((star, index) => {
    star.classList.toggle('active', index < currentRating);
  });
}

function updateStarsHover(hoverRating) {
  const stars = document.querySelectorAll('.star');
  stars.forEach((star, index) => {
    star.style.color = index < hoverRating ? '#ff6a00' : '#ddd';
  });
}

function updateRatingText() {
  const ratingText = document.getElementById('ratingText');
  const texts = ['', '很差', '一般', '不错', '很好', '极佳'];
  ratingText.textContent = `${currentRating}/5 - ${texts[currentRating]}`;
}

// 初始化书籍搜索
function initBookSearch() {
  const bookTitleInput = document.getElementById('bookTitle');
  const suggestionsDiv = document.getElementById('bookSuggestions');
  
  let searchTimeout;
  
  bookTitleInput.addEventListener('input', (e) => {
    const query = e.target.value.trim();
    
    clearTimeout(searchTimeout);
    
    if (query.length < 2) {
      hideSuggestions();
      return;
    }
    
    searchTimeout = setTimeout(() => {
      searchBooks(query);
    }, 300);
  });
  
  // 点击外部关闭建议
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.book-search')) {
      hideSuggestions();
    }
  });
}

// 搜索书籍
async function searchBooks(query) {
  try {
    console.log('🔍 搜索书籍:', query);
    
    const response = await api.request(`/books?search=${encodeURIComponent(query)}&limit=5`);
    
    if (response.success && response.data.books.length > 0) {
      showBookSuggestions(response.data.books);
    } else {
      hideSuggestions();
    }
    
  } catch (error) {
    console.error('❌ 搜索书籍失败:', error);
    hideSuggestions();
  }
}

// 显示书籍建议
function showBookSuggestions(books) {
  const suggestionsDiv = document.getElementById('bookSuggestions');
  
  suggestionsDiv.innerHTML = books.map(book => `
    <div class="book-suggestion" onclick="selectBook(${book.id}, '${escapeHtml(book.title)}', '${escapeHtml(book.author)}')">
      <div><strong>${escapeHtml(book.title)}</strong></div>
      <div style="font-size:12px;color:#666;">${escapeHtml(book.author)} ${book.publish_year ? '(' + book.publish_year + ')' : ''}</div>
    </div>
  `).join('');
  
  suggestionsDiv.style.display = 'block';
}

// 隐藏书籍建议
function hideSuggestions() {
  document.getElementById('bookSuggestions').style.display = 'none';
}

// 选择书籍
function selectBook(bookId, title, author) {
  selectedBookId = bookId;
  document.getElementById('bookTitle').value = title;
  document.getElementById('bookAuthor').value = author;
  hideSuggestions();
  
  console.log('✅ 选择书籍:', { bookId, title, author });
}

// 处理表单提交
async function handleSubmit(e) {
  e.preventDefault();
  
  if (isSubmitting) return;
  
  // 验证表单
  if (!validateForm()) {
    return;
  }
  
  isSubmitting = true;
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = '发布中...';
  
  try {
    // 收集表单数据
    const formData = collectFormData();
    
    console.log('📝 提交书评数据:', formData);
    
    // 如果没有选择现有书籍，先创建书籍
    let bookId = selectedBookId;
    if (!bookId) {
      const bookResponse = await api.request('/books', {
        method: 'POST',
        body: JSON.stringify({
          title: formData.bookTitle,
          author: formData.bookAuthor,
          isbn: formData.isbn || '',
          publisher: formData.publisher || '',
          publish_year: formData.publishYear,  // 修改为下划线命名
          cover_url: ''  // 添加封面URL字段（暂时为空）
        })
      });
      
      if (bookResponse.success) {
        bookId = bookResponse.data.book.id;
        console.log('✅ 创建书籍成功:', bookId);
      } else {
        throw new Error(bookResponse.message || '创建书籍失败');
      }
    }
    
    // 创建书评
    const reviewResponse = await api.request('/reviews', {
      method: 'POST',
      body: JSON.stringify({
        book_id: bookId,
        title: formData.reviewTitle,
        content: formData.content,
        rating: formData.rating
      })
    });
    
    if (reviewResponse.success) {
      showMessage('书评发布成功！', 'success');
      
      // 2秒后跳转到首页
      setTimeout(() => {
        window.location.href = '../index.html';
      }, 2000);
      
    } else {
      throw new Error(reviewResponse.message || '发布书评失败');
    }
    
  } catch (error) {
    console.error('❌ 发布书评失败:', error);
    showMessage('发布失败: ' + error.message, 'error');
  } finally {
    isSubmitting = false;
    submitBtn.disabled = false;
    submitBtn.textContent = '发布书评';
  }
}

// 验证表单
function validateForm() {
  const bookTitle = document.getElementById('bookTitle').value.trim();
  const bookAuthor = document.getElementById('bookAuthor').value.trim();
  const reviewTitle = document.getElementById('reviewTitle').value.trim();
  const content = document.getElementById('content').value.trim();
  
  if (!bookTitle) {
    showMessage('请输入书籍名称', 'error');
    return false;
  }
  
  if (!bookAuthor) {
    showMessage('请输入作者姓名', 'error');
    return false;
  }
  
  if (!reviewTitle) {
    showMessage('请输入书评标题', 'error');
    return false;
  }
  
  if (!content) {
    showMessage('请输入书评内容', 'error');
    return false;
  }
  
  if (content.length < 10) {
    showMessage('书评内容至少需要100字', 'error');
    return false;
  }
  
  if (content.length > 5000) {
    showMessage('书评内容不能超过5000字', 'error');
    return false;
  }
  
  if (currentRating === 0) {
    showMessage('请选择评分', 'error');
    return false;
  }
  
  return true;
}

// 收集表单数据
function collectFormData() {
  return {
    bookTitle: document.getElementById('bookTitle').value.trim(),
    bookAuthor: document.getElementById('bookAuthor').value.trim(),
    isbn: document.getElementById('isbn').value.trim(),
    publisher: document.getElementById('publisher').value.trim(),
    publishYear: document.getElementById('publishYear').value ? parseInt(document.getElementById('publishYear').value) : null,
    reviewTitle: document.getElementById('reviewTitle').value.trim(),
    content: document.getElementById('content').value.trim(),
    rating: currentRating
  };
}

// 重置表单
function resetForm() {
  document.getElementById('reviewForm').reset();
  currentRating = 0;
  selectedBookId = null;
  updateStars();
  document.getElementById('ratingText').textContent = '请选择评分';
  hideSuggestions();
  clearMessage();
}

// 显示消息
function showMessage(message, type = 'info') {
  const messageDiv = document.getElementById('message');
  messageDiv.className = type;
  messageDiv.textContent = message;
  messageDiv.style.display = 'block';
  
  // 3秒后自动隐藏（除了成功消息）
  if (type !== 'success') {
    setTimeout(() => {
      clearMessage();
    }, 3000);
  }
}

// 清除消息
function clearMessage() {
  const messageDiv = document.getElementById('message');
  messageDiv.style.display = 'none';
  messageDiv.textContent = '';
  messageDiv.className = '';
}

// 工具函数
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ========== Markdown 编辑器功能 ==========

// 更新 Markdown 预览
function updatePreview() {
  const content = document.getElementById('content').value;
  const preview = document.getElementById('markdownPreview');
  
  if (!content.trim()) {
    preview.innerHTML = '<p style="color:#999;text-align:center;padding:40px 0;">在左侧输入内容，这里会实时显示渲染效果...</p>';
    return;
  }
  
  if (typeof marked !== 'undefined') {
    try {
      // 配置 marked 选项
      marked.setOptions({
        breaks: true,        // 支持换行
        gfm: true,          // 支持 GitHub 风格的 Markdown
        headerIds: false,   // 禁用自动生成的标题 ID
        mangle: false       // 禁用邮箱地址混淆
      });
      
      preview.innerHTML = marked.parse(content);
    } catch (error) {
      console.error('❌ Markdown 渲染失败:', error);
      preview.innerHTML = `<p style="color:#c33;">渲染失败: ${error.message}</p>`;
    }
  } else {
    console.warn('⚠️ marked.js 未加载');
    preview.innerHTML = content.replace(/\n/g, '<br>');
  }
}

// 更新字数统计
function updateCharCount() {
  const content = document.getElementById('content').value;
  const charCount = document.getElementById('charCount');
  const length = content.length;
  
  charCount.textContent = length;
  
  // 根据字数变色
  if (length > 5000) {
    charCount.style.color = '#c33';
  } else if (length > 4500) {
    charCount.style.color = '#f90';
  } else {
    charCount.style.color = '#999';
  }
}

// 插入 Markdown 语法
function insertMarkdown(prefix, suffix) {
  const textarea = document.getElementById('content');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selectedText = textarea.value.substring(start, end);
  const beforeText = textarea.value.substring(0, start);
  const afterText = textarea.value.substring(end);
  
  // 如果没有选中文本，插入默认文本
  const insertText = selectedText || '文本';
  const newText = beforeText + prefix + insertText + suffix + afterText;
  
  textarea.value = newText;
  
  // 设置光标位置
  const newCursorPos = start + prefix.length + insertText.length;
  textarea.focus();
  textarea.setSelectionRange(newCursorPos, newCursorPos);
  
  // 更新预览和字数
  updatePreview();
  updateCharCount();
}

// 切换预览显示（移动端）
function togglePreview() {
  const previewPanel = document.getElementById('previewPanel');
  if (window.innerWidth <= 768) {
    if (previewPanel.style.display === 'none') {
      previewPanel.style.display = 'block';
    } else {
      previewPanel.style.display = 'none';
    }
  }
}

// 页面加载时初始化预览
document.addEventListener('DOMContentLoaded', function() {
  updatePreview();
  updateCharCount();
});

console.log('📝 书评发布页面脚本加载完成');
</script>
</body>
</html>