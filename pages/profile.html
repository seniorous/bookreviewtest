<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸»é¡µ - ä¹¦è¯„ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¯¼èˆªæ  */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: #667eea;
            color: white;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        /* ä¸ªäººä¿¡æ¯åŒº */
        .profile-header {
            display: flex;
            gap: 40px;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .avatar-section {
            flex-shrink: 0;
            text-align: center;
        }

        .avatar-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 20px;
        }

        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 6px solid #667eea;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .avatar-upload {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            display: none; /* é»˜è®¤éšè—ï¼Œåªæœ‰æœ¬äººæ‰æ˜¾ç¤º */
        }

        .avatar-upload:hover {
            transform: scale(1.1);
            background: #5a67d8;
        }

        .avatar-upload input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .user-info {
            flex: 1;
            padding-top: 20px;
        }

        .username {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .user-meta {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .signature-section {
            margin-bottom: 20px;
        }

        .signature {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            font-style: italic;
            color: #555;
            min-height: 60px;
            display: flex;
            align-items: center;
        }

        .signature.empty {
            color: #999;
            font-style: normal;
        }

        .signature-edit {
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .signature-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
            min-height: 80px;
            max-height: 120px;
        }

        .signature-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .signature-controls {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .privacy-settings {
            margin-top: 20px;
            display: none; /* é»˜è®¤éšè—ï¼Œåªæœ‰æœ¬äººæ‰æ˜¾ç¤º */
        }

        .privacy-btn {
            background: #f7fafc;
            color: #4a5568;
            border: 1px solid #e2e8f0;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .privacy-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        /* ç»Ÿè®¡æ•°æ®åŒº */
        .stats-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #667eea;
            border-radius: 2px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 16px;
            opacity: 0.9;
        }

        /* å†å²è®°å½•åŒº */
        .history-section {
            margin-bottom: 30px;
        }

        .history-list {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .history-item {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.3s ease;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item:hover {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            margin: 0 -10px;
            padding: 15px 10px;
        }

        .history-icon {
            width: 40px;
            height: 40px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
        }

        .history-content {
            flex: 1;
        }

        .history-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            cursor: pointer;
            text-decoration: none;
        }

        .history-title:hover {
            color: #667eea;
        }

        .history-meta {
            color: #666;
            font-size: 14px;
        }

        .history-stats {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }

        .history-stat {
            color: #888;
            font-size: 12px;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* é”™è¯¯çŠ¶æ€ */
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.error {
            background: #e74c3c;
        }

        .toast.success {
            background: #27ae60;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .main-content {
                padding: 20px;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .avatar-container {
                width: 200px;
                height: 200px;
            }

            .username {
                font-size: 28px;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-number {
                font-size: 28px;
            }

            .history-item {
                flex-direction: column;
                gap: 10px;
            }

            .nav-content {
                flex-direction: column;
                gap: 15px;
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* éšç§è®¾ç½®æ¨¡æ€æ¡† */
        .privacy-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .privacy-modal.show {
            display: flex;
        }

        .privacy-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .privacy-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .privacy-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .privacy-option:last-child {
            border-bottom: none;
        }

        .privacy-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .privacy-switch.active {
            background: #667eea;
        }

        .privacy-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .privacy-switch.active::after {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-content">
            <a href="../index.html" class="logo">ğŸ“š ä¹¦è¯„ç³»ç»Ÿ</a>
            <div class="nav-links">
                <a href="../index.html">é¦–é¡µ</a>
                <a href="add-review.html">å†™ä¹¦è¯„</a>
                <div id="auth-area">
                    <!-- åŠ¨æ€åŠ è½½ç™»å½•/ç”¨æˆ·ä¿¡æ¯ -->
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="main-content">
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸ªäººä¸»é¡µä¸­...</p>
            </div>

            <!-- é”™è¯¯çŠ¶æ€ -->
            <div id="error" class="error" style="display: none;">
                <p id="error-message">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
            </div>

            <!-- ä¸ªäººä¿¡æ¯åŒº -->
            <div id="profile-content" style="display: none;">
                <div class="profile-header">
                    <div class="avatar-section">
                        <div class="avatar-container">
                            <img id="user-avatar" src="../backend/uploads/avatars/default.svg" alt="ç”¨æˆ·å¤´åƒ" class="avatar">
                            <button id="avatar-upload-btn" class="avatar-upload" title="ä¸Šä¼ å¤´åƒ">
                                ğŸ“·
                                <input type="file" id="avatar-input" accept="image/jpeg,image/jpg,image/png,image/gif">
                            </button>
                        </div>
                    </div>
                    <div class="user-info">
                        <h1 id="username" class="username">ç”¨æˆ·å</h1>
                        <div class="user-meta">
                            <span id="join-date">åŠ å…¥æ—¶é—´ï¼š2024-01-01</span>
                        </div>
                        <div class="signature-section">
                            <div id="signature-display" class="signature empty">
                                è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...
                            </div>
                            <div id="signature-edit" class="signature-edit">
                                <textarea id="signature-input" class="signature-input" placeholder="å†™ä¸‹ä½ çš„ä¸ªæ€§ç­¾å...ï¼ˆæœ€å¤š30å­—ï¼‰" maxlength="30"></textarea>
                                <div class="signature-controls">
                                    <button id="signature-cancel" class="btn btn-secondary">å–æ¶ˆ</button>
                                    <button id="signature-save" class="btn btn-primary">ä¿å­˜</button>
                                </div>
                            </div>
                        </div>
                        <div id="privacy-settings" class="privacy-settings">
                            <button id="privacy-btn" class="privacy-btn">ğŸ”’ éšç§è®¾ç½®</button>
                        </div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡æ•°æ®åŒº -->
                <div class="stats-section">
                    <h2 class="section-title">ğŸ“Š æ•°æ®ç»Ÿè®¡</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div id="reviews-count" class="stat-number">0</div>
                            <div class="stat-label">å‘è¡¨ä¹¦è¯„</div>
                        </div>
                        <div class="stat-card">
                            <div id="likes-received" class="stat-number">0</div>
                            <div class="stat-label">è·å¾—ç‚¹èµ</div>
                        </div>
                        <div class="stat-card">
                            <div id="favorites-count" class="stat-number">0</div>
                            <div class="stat-label">æ”¶è—ä¹¦è¯„</div>
                        </div>
                        <div class="stat-card">
                            <div id="favorites-received" class="stat-number">0</div>
                            <div class="stat-label">è·å¾—æ”¶è—</div>
                        </div>
                        <div class="stat-card">
                            <div id="comments-count" class="stat-number">0</div>
                            <div class="stat-label">å‘è¡¨è¯„è®º</div>
                        </div>
                    </div>
                </div>

                <!-- æˆ‘çš„ä¹¦è¯„ -->
                <div class="history-section">
                    <h2 class="section-title">ğŸ“ æˆ‘çš„ä¹¦è¯„</h2>
                    <div id="my-reviews" class="history-list">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- æˆ‘çš„æ”¶è— -->
                <div class="history-section">
                    <h2 class="section-title">â­ æˆ‘çš„æ”¶è—</h2>
                    <div id="my-favorites" class="history-list">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- æˆ‘çš„è¯„è®º -->
                <div class="history-section">
                    <h2 class="section-title">ğŸ’¬ æˆ‘çš„è¯„è®º</h2>
                    <div id="my-comments" class="history-list">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- éšç§è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="privacy-modal" class="privacy-modal">
        <div class="privacy-content">
            <h3 class="privacy-title">éšç§è®¾ç½®</h3>
            <div class="privacy-option">
                <span>å¤´åƒå¯è§æ€§</span>
                <div id="privacy-avatar" class="privacy-switch active" data-field="avatar"></div>
            </div>
            <div class="privacy-option">
                <span>ä¸ªäººç­¾åå¯è§æ€§</span>
                <div id="privacy-signature" class="privacy-switch active" data-field="signature"></div>
            </div>
            <div class="privacy-option">
                <span>ç»Ÿè®¡æ•°æ®å¯è§æ€§</span>
                <div id="privacy-stats" class="privacy-switch active" data-field="stats"></div>
            </div>
            <div class="privacy-option">
                <span>å†å²è®°å½•å¯è§æ€§</span>
                <div id="privacy-history" class="privacy-switch active" data-field="history"></div>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button id="privacy-close" class="btn btn-secondary">å…³é—­</button>
                <button id="privacy-save" class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div id="toast" class="toast"></div>

    <script src="../js/api.js"></script>
    <script src="../js/auth-sync.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentUserId = null;
        let currentUser = null;
        let isOwnProfile = false;
        let profileData = null;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ“– ä¸ªäººä¸»é¡µåˆå§‹åŒ–...');
            
            try {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                await checkLoginStatus();
                
                // è·å–URLå‚æ•°ä¸­çš„ç”¨æˆ·ID
                const urlParams = new URLSearchParams(window.location.search);
                const targetUserId = urlParams.get('user');
                
                // ç¡®å®šè¦æ˜¾ç¤ºçš„ç”¨æˆ·ID
                if (targetUserId) {
                    currentUserId = targetUserId;
                    // å…¼å®¹ä¸åŒçš„ ID å­—æ®µå
                    const userId = currentUser?.id || currentUser?.userId || currentUser?.user_id;
                    isOwnProfile = currentUser && userId == targetUserId;
                } else {
                    // æ²¡æœ‰æŒ‡å®šç”¨æˆ·IDï¼Œæ˜¾ç¤ºå½“å‰ç™»å½•ç”¨æˆ·çš„ä¸»é¡µ
                    if (!currentUser) {
                        showError('è¯·å…ˆç™»å½•');
                        return;
                    }
                    // å…¼å®¹ä¸åŒçš„ ID å­—æ®µåï¼ˆidã€userIdã€user_idï¼‰
                    currentUserId = currentUser.id || currentUser.userId || currentUser.user_id;
                    if (!currentUserId) {
                        console.error('âŒ æ— æ³•è·å–ç”¨æˆ·IDï¼Œç”¨æˆ·å¯¹è±¡:', currentUser);
                        showError('æ— æ³•è·å–ç”¨æˆ·IDï¼Œè¯·é‡æ–°ç™»å½•');
                        return;
                    }
                    isOwnProfile = true;
                }
                
                console.log('å½“å‰ç”¨æˆ·ID:', currentUserId);
                console.log('æ˜¯å¦æœ¬äººä¸»é¡µ:', isOwnProfile);
                console.log('å½“å‰ç”¨æˆ·å¯¹è±¡:', currentUser);
                
                // åŠ è½½ç”¨æˆ·èµ„æ–™
                await loadUserProfile();
                
                // ç»‘å®šäº‹ä»¶
                bindEvents();
                
                console.log('âœ… ä¸ªäººä¸»é¡µåˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ ä¸ªäººä¸»é¡µåˆå§‹åŒ–å¤±è´¥:', error);
                hideLoading();
                showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        });

        // è§„èŒƒåŒ–ç”¨æˆ·å¯¹è±¡ï¼Œç¡®ä¿æœ‰ id å­—æ®µ
        function normalizeUser(user) {
            if (!user) return null;
            
            // ç¡®ä¿ id å­—æ®µå­˜åœ¨
            if (!user.id && (user.userId || user.user_id)) {
                user.id = user.userId || user.user_id;
            }
            
            return user;
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            const authArea = document.getElementById('auth-area');
            
            try {
                // é¦–å…ˆæ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰tokenå’Œç”¨æˆ·ä¿¡æ¯
                if (api.isLoggedIn()) {
                    console.log('ğŸ” æ£€æµ‹åˆ°æœ¬åœ°tokenï¼ŒéªŒè¯æœ‰æ•ˆæ€§...');
                    
                    // å°è¯•ä»localStorageè·å–ç”¨æˆ·ä¿¡æ¯
                    const localUser = api.getCurrentUser();
                    if (localUser) {
                        console.log('ğŸ“‹ ä»æœ¬åœ°è·å–ç”¨æˆ·ä¿¡æ¯:', localUser);
                        currentUser = normalizeUser(localUser);
                    }
                    
                    // éªŒè¯tokenæœ‰æ•ˆæ€§
                    const response = await api.verifyToken();
                    if (response.success && response.data) {
                        // Tokenæœ‰æ•ˆï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯
                        currentUser = normalizeUser(response.data.user);
                        console.log('âœ… TokenéªŒè¯æˆåŠŸï¼Œç”¨æˆ·å·²ç™»å½•:', currentUser);
                        
                        authArea.innerHTML = `
                            <a href="profile.html">ğŸ‘¤ ${currentUser.username}</a>
                            <button onclick="logout()" style="background: none; border: none; color: #333; cursor: pointer; padding: 8px 16px; border-radius: 8px;">é€€å‡º</button>
                        `;
                    } else {
                        // Tokenæ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°æ•°æ®
                        console.log('âŒ Tokenæ— æ•ˆï¼Œæ¸…é™¤ç™»å½•çŠ¶æ€');
                        await api.logout();
                        currentUser = null;
                        authArea.innerHTML = `
                            <a href="login.html">ç™»å½•</a>
                            <a href="register.html">æ³¨å†Œ</a>
                        `;
                    }
                } else {
                    console.log('ğŸ“­ æœªæ£€æµ‹åˆ°ç™»å½•token');
                    currentUser = null;
                    authArea.innerHTML = `
                        <a href="login.html">ç™»å½•</a>
                        <a href="register.html">æ³¨å†Œ</a>
                    `;
                }
            } catch (error) {
                console.error('âŒ æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
                // ç½‘ç»œé”™è¯¯æ—¶ï¼Œå¦‚æœæœ‰æœ¬åœ°ç”¨æˆ·ä¿¡æ¯ï¼Œä¿æŒç™»å½•çŠ¶æ€
                const localUser = api.getCurrentUser();
                if (localUser && api.isLoggedIn()) {
                    console.log('ğŸ”„ ç½‘ç»œé”™è¯¯ï¼Œä½¿ç”¨æœ¬åœ°ç”¨æˆ·ä¿¡æ¯ç»´æŒç™»å½•çŠ¶æ€');
                    currentUser = normalizeUser(localUser);
                    authArea.innerHTML = `
                        <a href="profile.html">ğŸ‘¤ ${currentUser.username}</a>
                        <button onclick="logout()" style="background: none; border: none; color: #333; cursor: pointer; padding: 8px 16px; border-radius: 8px;">é€€å‡º</button>
                    `;
                } else {
                    currentUser = null;
                    authArea.innerHTML = `
                        <a href="login.html">ç™»å½•</a>
                        <a href="register.html">æ³¨å†Œ</a>
                    `;
                }
            }
        }

        // åŠ è½½ç”¨æˆ·èµ„æ–™
        async function loadUserProfile() {
            try {
                console.log('ğŸ” è°ƒç”¨APIè·å–ç”¨æˆ·èµ„æ–™...');
                
                // è°ƒç”¨APIè·å–ç”¨æˆ·èµ„æ–™
                const response = await api.getUserProfile(currentUserId);
                
                console.log('âœ… APIå“åº”:', response);
                
                // æå– data å­—æ®µ
                if (response.success && response.data) {
                    profileData = response.data;
                    console.log('âœ… ç”¨æˆ·èµ„æ–™è·å–æˆåŠŸ:', profileData);
                    
                    // æ˜¾ç¤ºç”¨æˆ·èµ„æ–™
                    displayUserProfile();
                    
                    hideLoading();
                    document.getElementById('profile-content').style.display = 'block';
                } else {
                    throw new Error(response.message || 'è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥');
                }
                
            } catch (error) {
                console.error('âŒ åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                hideLoading();
                showError('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·èµ„æ–™
        function displayUserProfile() {
            const { user, stats, history } = profileData;
            
            // åŸºæœ¬ä¿¡æ¯
            document.getElementById('username').textContent = user.username;
            document.getElementById('join-date').textContent = `åŠ å…¥æ—¶é—´ï¼š${formatDate(user.created_at)}`;
            
            // å¤„ç†å¤´åƒURLï¼ˆæ·»åŠ åç«¯åœ°å€å‰ç¼€ï¼‰
            let avatarSrc = '../backend/uploads/avatars/default.svg';
            if (user.avatar_url) {
                // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ·»åŠ åç«¯åœ°å€
                if (user.avatar_url.startsWith('/')) {
                    avatarSrc = `http://localhost:3001${user.avatar_url}`;
                } else if (user.avatar_url.startsWith('http')) {
                    avatarSrc = user.avatar_url;
                } else {
                    avatarSrc = user.avatar_url;
                }
            }
            document.getElementById('user-avatar').src = avatarSrc;
            
            // ä¸ªäººç­¾å
            const signatureDisplay = document.getElementById('signature-display');
            if (user.signature && user.signature.trim()) {
                signatureDisplay.textContent = user.signature;
                signatureDisplay.classList.remove('empty');
            } else {
                signatureDisplay.textContent = 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...';
                signatureDisplay.classList.add('empty');
            }
            
            // ç»Ÿè®¡æ•°æ®
            if (stats) {
                document.getElementById('reviews-count').textContent = stats.reviews_count || 0;
                document.getElementById('likes-received').textContent = stats.likes_received || 0;
                document.getElementById('favorites-count').textContent = stats.favorites_count || 0;
                document.getElementById('favorites-received').textContent = stats.favorites_received || 0;
                document.getElementById('comments-count').textContent = stats.comments_count || 0;
            } else {
                // éšç§è®¾ç½®ä¸å…è®¸æŸ¥çœ‹ç»Ÿè®¡æ•°æ®
                document.querySelector('.stats-section').style.display = 'none';
            }
            
            // æ˜¾ç¤º/éšè—ç¼–è¾‘åŠŸèƒ½
            if (isOwnProfile) {
                document.getElementById('avatar-upload-btn').style.display = 'block';
                document.getElementById('privacy-settings').style.display = 'block';
                
                // æ·»åŠ ç­¾åç¼–è¾‘åŠŸèƒ½
                signatureDisplay.style.cursor = 'pointer';
                signatureDisplay.title = 'ç‚¹å‡»ç¼–è¾‘ç­¾å';
            }
            
            // åŠ è½½å†å²è®°å½•
            loadHistoryData();
        }

        // åŠ è½½å†å²è®°å½•æ•°æ®
        function loadHistoryData() {
            const { history } = profileData;
            
            if (!history) {
                // éšç§è®¾ç½®ä¸å…è®¸æŸ¥çœ‹å†å²è®°å½•
                document.querySelectorAll('.history-section').forEach(section => {
                    section.style.display = 'none';
                });
                return;
            }
            
            // æˆ‘çš„ä¹¦è¯„
            const reviewsContainer = document.getElementById('my-reviews');
            if (history.reviews && history.reviews.length > 0) {
                reviewsContainer.innerHTML = history.reviews.map(review => `
                    <div class="history-item">
                        <div class="history-icon">ğŸ“</div>
                        <div class="history-content">
                            <a href="review-detail.html?id=${review.id}" class="history-title">${escapeHtml(review.title)}</a>
                            <div class="history-meta">ã€Š${escapeHtml(review.book_title)}ã€‹- ${escapeHtml(review.book_author)}</div>
                            <div class="history-stats">
                                <span class="history-stat">â­ ${review.rating}/5</span>
                                <span class="history-stat">ğŸ‘ï¸ ${review.views}</span>
                                <span class="history-stat">ğŸ‘ ${review.likes_count}</span>
                                <span class="history-stat">ğŸ’¬ ${review.comments_count}</span>
                                <span class="history-stat">${formatDate(review.created_at)}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                reviewsContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">æš‚æ— ä¹¦è¯„</p>';
            }
            
            // æˆ‘çš„æ”¶è—
            const favoritesContainer = document.getElementById('my-favorites');
            if (history.favorites && history.favorites.length > 0) {
                favoritesContainer.innerHTML = history.favorites.map(favorite => `
                    <div class="history-item">
                        <div class="history-icon">â­</div>
                        <div class="history-content">
                            <a href="review-detail.html?id=${favorite.id}" class="history-title">${escapeHtml(favorite.title)}</a>
                            <div class="history-meta">ã€Š${escapeHtml(favorite.book_title)}ã€‹- ${escapeHtml(favorite.book_author)} | ä½œè€…ï¼š${escapeHtml(favorite.author_name)}</div>
                            <div class="history-stats">
                                <span class="history-stat">â­ ${favorite.rating}/5</span>
                                <span class="history-stat">ğŸ‘ï¸ ${favorite.views}</span>
                                <span class="history-stat">ğŸ‘ ${favorite.likes_count}</span>
                                <span class="history-stat">æ”¶è—äº ${formatDate(favorite.favorited_at)}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                favoritesContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">æš‚æ— æ”¶è—</p>';
            }
            
            // æˆ‘çš„è¯„è®º
            const commentsContainer = document.getElementById('my-comments');
            if (history.comments && history.comments.length > 0) {
                commentsContainer.innerHTML = history.comments.map(comment => `
                    <div class="history-item">
                        <div class="history-icon">ğŸ’¬</div>
                        <div class="history-content">
                            <a href="review-detail.html?id=${comment.review_id}" class="history-title">è¯„è®ºï¼š${escapeHtml(comment.review_title)}</a>
                            <div class="history-meta">ã€Š${escapeHtml(comment.book_title)}ã€‹- ${escapeHtml(comment.book_author)}</div>
                            <div style="margin-top: 8px; color: #555; font-size: 14px;">${formatContent(escapeHtml(comment.content))}</div>
                            <div class="history-stats">
                                <span class="history-stat">${formatDate(comment.created_at)}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                commentsContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">æš‚æ— è¯„è®º</p>';
            }
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // ç­¾åç¼–è¾‘
            if (isOwnProfile) {
                const signatureDisplay = document.getElementById('signature-display');
                const signatureEdit = document.getElementById('signature-edit');
                const signatureInput = document.getElementById('signature-input');
                const signatureSave = document.getElementById('signature-save');
                const signatureCancel = document.getElementById('signature-cancel');
                
                signatureDisplay.addEventListener('click', () => {
                    signatureInput.value = profileData.user.signature || '';
                    signatureDisplay.style.display = 'none';
                    signatureEdit.style.display = 'flex';
                    signatureInput.focus();
                });
                
                signatureCancel.addEventListener('click', () => {
                    signatureEdit.style.display = 'none';
                    signatureDisplay.style.display = 'flex';
                });
                
                signatureSave.addEventListener('click', saveSignature);
                
                // å¤´åƒä¸Šä¼ 
                const avatarInput = document.getElementById('avatar-input');
                avatarInput.addEventListener('change', handleAvatarUpload);
                
                // éšç§è®¾ç½®
                const privacyBtn = document.getElementById('privacy-btn');
                const privacyModal = document.getElementById('privacy-modal');
                const privacyClose = document.getElementById('privacy-close');
                const privacySave = document.getElementById('privacy-save');
                
                privacyBtn.addEventListener('click', () => {
                    privacyModal.classList.add('show');
                    loadPrivacySettings();
                });
                
                privacyClose.addEventListener('click', () => {
                    privacyModal.classList.remove('show');
                });
                
                privacySave.addEventListener('click', savePrivacySettings);
                
                // éšç§å¼€å…³
                document.querySelectorAll('.privacy-switch').forEach(switchEl => {
                    switchEl.addEventListener('click', () => {
                        switchEl.classList.toggle('active');
                    });
                });
            }
        }

        // ä¿å­˜ç­¾å
        async function saveSignature() {
            const signatureInput = document.getElementById('signature-input');
            const newSignature = signatureInput.value.trim();
            
            if (newSignature.length > 30) {
                showToast('ç­¾åä¸èƒ½è¶…è¿‡30ä¸ªå­—ç¬¦', 'error');
                return;
            }
            
            try {
                console.log('ğŸ” ä¿å­˜ç­¾å:', newSignature);
                
                // è°ƒç”¨APIä¿å­˜ç­¾å
                await api.updateUserProfile({ signature: newSignature });
                
                // æ›´æ–°æ˜¾ç¤º
                profileData.user.signature = newSignature;
                const signatureDisplay = document.getElementById('signature-display');
                const signatureEdit = document.getElementById('signature-edit');
                
                if (newSignature) {
                    signatureDisplay.textContent = newSignature;
                    signatureDisplay.classList.remove('empty');
                } else {
                    signatureDisplay.textContent = 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...';
                    signatureDisplay.classList.add('empty');
                }
                
                signatureEdit.style.display = 'none';
                signatureDisplay.style.display = 'flex';
                
                showToast('ç­¾åä¿å­˜æˆåŠŸ', 'success');
                console.log('âœ… ç­¾åä¿å­˜æˆåŠŸ');
            } catch (error) {
                console.error('âŒ ä¿å­˜ç­¾åå¤±è´¥:', error);
                showToast('ä¿å­˜ç­¾åå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¤„ç†å¤´åƒä¸Šä¼ 
        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('âš ï¸ æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            console.log('ğŸ“· é€‰æ‹©çš„æ–‡ä»¶:', {
                name: file.name,
                size: file.size,
                type: file.type
            });
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                showToast('âŒ åªæ”¯æŒ JPGã€PNGã€GIF æ ¼å¼çš„å›¾ç‰‡', 'error');
                event.target.value = ''; // æ¸…ç©ºé€‰æ‹©
                return;
            }
            
            // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ2MBï¼‰
            const maxSize = 2 * 1024 * 1024;
            if (file.size > maxSize) {
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                showToast(`âŒ å›¾ç‰‡å¤§å°ä¸º ${sizeMB}MBï¼Œä¸èƒ½è¶…è¿‡ 2MB`, 'error');
                event.target.value = ''; // æ¸…ç©ºé€‰æ‹©
                return;
            }
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!api.isLoggedIn()) {
                showToast('âŒ è¯·å…ˆç™»å½•', 'error');
                event.target.value = '';
                return;
            }
            
            try {
                console.log('ğŸ” å¼€å§‹ä¸Šä¼ å¤´åƒ:', file.name, 'å¤§å°:', (file.size / 1024).toFixed(2) + 'KB');
                
                // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
                const avatarImg = document.getElementById('user-avatar');
                const uploadBtn = document.getElementById('avatar-upload-btn');
                const originalSrc = avatarImg.src;
                
                // ç¦ç”¨ä¸Šä¼ æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ä¸Šä¼ 
                uploadBtn.disabled = true;
                uploadBtn.style.opacity = '0.5';
                uploadBtn.innerHTML = 'â³';
                
                showToast('â³ æ­£åœ¨ä¸Šä¼ å¤´åƒ...', 'info');
                
                // ä¸´æ—¶æ˜¾ç¤ºé¢„è§ˆï¼ˆä»…åœ¨æœ¬åœ°ï¼‰
                const reader = new FileReader();
                reader.onload = (e) => {
                    avatarImg.style.opacity = '0.6';
                    avatarImg.src = e.target.result;
                };
                reader.readAsDataURL(file);
                
                // è°ƒç”¨APIä¸Šä¼ å¤´åƒ
                const result = await api.uploadAvatar(file);
                
                console.log('âœ… å¤´åƒä¸Šä¼ APIè¿”å›:', result, 'ç±»å‹:', typeof result);
                
                // æå–å¤´åƒURLï¼ˆå…¼å®¹ä¸åŒè¿”å›æ ¼å¼ï¼‰
                let avatarUrl;
                if (typeof result === 'string') {
                    avatarUrl = result;
                } else if (result && result.avatar_url) {
                    avatarUrl = result.avatar_url;
                } else if (result && result.data && result.data.avatar_url) {
                    avatarUrl = result.data.avatar_url;
                } else {
                    throw new Error('æ— æ³•ä»å“åº”ä¸­æå–å¤´åƒURL');
                }
                
                console.log('âœ… æå–çš„å¤´åƒURL:', avatarUrl);
                
                // æ›´æ–°å¤´åƒURLï¼ˆæ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜ï¼‰
                const newAvatarUrl = avatarUrl.includes('?') 
                    ? `${avatarUrl}&t=${Date.now()}` 
                    : `${avatarUrl}?t=${Date.now()}`;
                
                profileData.user.avatar_url = avatarUrl;
                avatarImg.src = newAvatarUrl;
                avatarImg.style.opacity = '1';
                
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©ï¼Œå…è®¸å†æ¬¡ä¸Šä¼ ç›¸åŒæ–‡ä»¶
                event.target.value = '';
                
                showToast('âœ… å¤´åƒä¸Šä¼ æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('âŒ ä¸Šä¼ å¤´åƒå¤±è´¥:', error);
                
                // æ¢å¤åŸå§‹å¤´åƒ
                const avatarImg = document.getElementById('user-avatar');
                avatarImg.src = profileData.user.avatar_url || '../backend/uploads/avatars/default.svg';
                avatarImg.style.opacity = '1';
                
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                event.target.value = '';
                
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                let errorMsg = 'ä¸Šä¼ å¤±è´¥';
                if (error.message) {
                    errorMsg = error.message;
                } else if (typeof error === 'string') {
                    errorMsg = error;
                }
                
                showToast(`âŒ ${errorMsg}`, 'error');
                
            } finally {
                // æ¢å¤ä¸Šä¼ æŒ‰é’®çŠ¶æ€
                const uploadBtn = document.getElementById('avatar-upload-btn');
                uploadBtn.disabled = false;
                uploadBtn.style.opacity = '1';
                uploadBtn.innerHTML = 'ğŸ“·';
            }
        }

        // åŠ è½½éšç§è®¾ç½®
        function loadPrivacySettings() {
            const settings = profileData.user.privacy_settings;
            
            Object.keys(settings).forEach(key => {
                const switchEl = document.querySelector(`[data-field="${key}"]`);
                if (switchEl) {
                    if (settings[key]) {
                        switchEl.classList.add('active');
                    } else {
                        switchEl.classList.remove('active');
                    }
                }
            });
        }

        // ä¿å­˜éšç§è®¾ç½®
        async function savePrivacySettings() {
            const settings = {};
            
            document.querySelectorAll('.privacy-switch').forEach(switchEl => {
                const field = switchEl.dataset.field;
                settings[field] = switchEl.classList.contains('active');
            });
            
            try {
                console.log('ğŸ” ä¿å­˜éšç§è®¾ç½®:', settings);
                
                // è°ƒç”¨APIä¿å­˜éšç§è®¾ç½®
                await api.updateUserProfile({ privacy_settings: settings });
                
                profileData.user.privacy_settings = settings;
                document.getElementById('privacy-modal').classList.remove('show');
                
                showToast('éšç§è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
                console.log('âœ… éšç§è®¾ç½®ä¿å­˜æˆåŠŸ');
            } catch (error) {
                console.error('âŒ ä¿å­˜éšç§è®¾ç½®å¤±è´¥:', error);
                showToast('ä¿å­˜éšç§è®¾ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                await api.logout();
                showToast('é€€å‡ºç™»å½•æˆåŠŸ', 'success');
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 1000);
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                showToast('é€€å‡ºç™»å½•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å·¥å…·å‡½æ•°
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatContent(content) {
            return content.replace(/\n/g, '<br>');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
