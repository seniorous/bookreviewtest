<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ä¹¦è¯„è¯¦æƒ… - ä¹¦è¯„ç®¡ç†ç³»ç»Ÿ</title>

<!-- APIå·¥å…·ç±» -->
<script src="../js/api.js"></script>
<!-- è®¤è¯åŒæ­¥å·¥å…· -->
<script src="../js/auth-sync.js"></script>

<!-- Markdown æ¸²æŸ“åº“ -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Segoe UI",Roboto,"Noto Sans CJK SC","Microsoft YaHei","Helvetica Neue",Arial;background:#f8f9fa}
a{color:#ff6a00;text-decoration:none}
a:hover{text-decoration:underline}

/* å¤´éƒ¨å¯¼èˆª */
.header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee}
.nav{max-width:1200px;margin:auto;display:flex;align-items:center;gap:20px;padding:12px 16px}
.brand{font-weight:700;color:#ff6a00}
.nav-spacer{flex:1}
.btn{display:inline-block;padding:10px 16px;border:none;border-radius:8px;background:#ff6a00;color:#fff;cursor:pointer;text-decoration:none}
.btn.secondary{background:#eee;color:#333}
.btn:hover{text-decoration:none;opacity:0.9}

/* ä¸»å®¹å™¨ */
.container{max-width:800px;margin:auto;padding:20px 16px}

/* è¿”å›æŒ‰é’® */
.back-btn{display:inline-flex;align-items:center;gap:8px;color:#666;margin-bottom:20px;padding:8px 12px;border-radius:8px;transition:all 0.2s}
.back-btn:hover{background:#f0f0f0;text-decoration:none}

/* ä¹¦è¯„å†…å®¹åŒº */
.review-detail{background:#fff;border-radius:12px;padding:30px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}

/* ä¹¦è¯„å¤´éƒ¨ */
.review-header{margin-bottom:24px}
.review-title{font-size:28px;font-weight:700;color:#333;margin:0 0 16px;line-height:1.3}
.review-meta{display:flex;flex-wrap:wrap;gap:20px;align-items:center;color:#666;font-size:14px;margin-bottom:16px}
.author-info{display:flex;align-items:center;gap:8px}
.avatar{width:32px;height:32px;border-radius:50%;background:#f0f0f0}
.rating{color:#ff6a00;font-size:18px;font-weight:600}
.book-info{background:#f8f9fa;padding:16px;border-radius:8px;margin-bottom:20px}
.book-title{font-size:16px;font-weight:600;color:#333;margin-bottom:4px}
.book-author{color:#666;font-size:14px}

/* ä¹¦è¯„å†…å®¹ */
.review-content{font-size:16px;line-height:1.7;color:#333;margin-bottom:24px}
.review-content h1,.review-content h2,.review-content h3{margin:20px 0 10px;font-weight:600}
.review-content h1{font-size:24px;border-bottom:2px solid #eee;padding-bottom:8px}
.review-content h2{font-size:20px}
.review-content h3{font-size:18px}
.review-content p{margin:12px 0}
.review-content ul,.review-content ol{margin:12px 0;padding-left:24px}
.review-content li{margin:6px 0}
.review-content blockquote{margin:16px 0;padding:12px 16px;border-left:4px solid #ff6a00;background:#f8f9fa;color:#666}
.review-content code{background:#f4f4f4;padding:2px 6px;border-radius:3px;font-family:monospace;font-size:14px}
.review-content pre{background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;margin:12px 0}
.review-content pre code{background:none;padding:0}
.review-content a{color:#ff6a00;text-decoration:underline}
.review-content img{max-width:100%;height:auto;border-radius:8px;margin:12px 0}

/* äº’åŠ¨åŒºåŸŸ */
.interaction-bar{display:flex;align-items:center;gap:16px;padding:16px 0;border-top:1px solid #eee;border-bottom:1px solid #eee;margin-bottom:24px}
.action-btn{display:flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#fff;color:#666;cursor:pointer;transition:all 0.2s;font-size:14px}
.action-btn:hover{background:#f8f9fa;border-color:#ccc}
.action-btn.active{color:#ff6a00;border-color:#ff6a00;background:#fff5f0}
.action-btn:disabled{opacity:0.6;cursor:not-allowed;pointer-events:none}
.stats-item{display:flex;align-items:center;gap:4px;color:#999;font-size:14px}

/* Toastæç¤º */
.toast{position:fixed;top:20px;right:20px;background:#333;color:#fff;padding:12px 20px;border-radius:8px;z-index:1000;opacity:0;transform:translateX(100%);transition:all 0.3s ease}
.toast.show{opacity:1;transform:translateX(0)}
.toast.error{background:#e74c3c}
.toast.success{background:#27ae60}

/* è¯„è®ºåŒºåŸŸ */
.comments-section{margin-top:30px}
.section-title{font-size:20px;font-weight:600;color:#333;margin-bottom:20px}

/* è¯„è®ºè¾“å…¥æ¡† */
.comment-form{background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:24px}
.comment-textarea{width:100%;min-height:100px;padding:12px;border:1px solid #ddd;border-radius:8px;resize:vertical;font-family:inherit;font-size:14px}
.comment-actions{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
.char-count{color:#999;font-size:12px}
.submit-btn{padding:8px 16px;background:#ff6a00;color:#fff;border:none;border-radius:6px;cursor:pointer}
.submit-btn:disabled{background:#ccc;cursor:not-allowed}

/* è¯„è®ºåˆ—è¡¨ */
.comments-list{space-y:16px}
.comment-item{background:#fff;padding:16px;border-radius:8px;border:1px solid #eee}
.comment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.comment-author{display:flex;align-items:center;gap:8px;font-weight:600;color:#333}
.comment-time{color:#999;font-size:12px}
.comment-content{color:#555;line-height:1.6;margin-bottom:8px}
.comment-actions{display:flex;gap:12px}
.comment-action{color:#999;font-size:12px;cursor:pointer}
.comment-action:hover{color:#ff6a00}

/* å›å¤åŒºåŸŸ */
.reply-item{margin-left:20px;margin-top:12px;padding-left:16px;border-left:3px solid #f0f0f0}
.reply-form{background:#f8f9fa;padding:16px;border-radius:8px;margin-top:12px}
.reply-form .comment-textarea{min-height:80px}
.replies{margin-top:16px}

/* ä½œè€…æ ‡è¯† */
.author-badge{background:#ff6a00;color:#fff;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:6px}

/* åŠ è½½çŠ¶æ€ */
.loading{display:flex;justify-content:center;align-items:center;padding:40px;color:#666}
.loading::after{content:'';width:20px;height:20px;border:2px solid #ff6a00;border-top:2px solid transparent;border-radius:50%;animation:spin 1s linear infinite;margin-left:10px}
@keyframes spin{to{transform:rotate(360deg)}}

/* é”™è¯¯çŠ¶æ€ */
.error{text-align:center;padding:40px;color:#999}
.error-message{font-size:16px;margin-bottom:16px}

/* ç©ºçŠ¶æ€ */
.empty{text-align:center;padding:40px;color:#999}

/* å“åº”å¼ */
@media (max-width: 768px) {
  .container{padding:16px 12px}
  .review-detail{padding:20px}
  .review-title{font-size:24px}
  .review-meta{flex-direction:column;align-items:flex-start;gap:8px}
  .interaction-bar{flex-wrap:wrap;gap:12px}
}
</style>
</head>
<body>
<header class="header">
  <nav class="nav">
    <div class="brand">ğŸ“š BookReviewer</div>
    <div class="nav-spacer"></div>
    <div id="navButtons">
      <!-- å¯¼èˆªæŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€æ’å…¥ -->
    </div>
  </nav>
</header>

<div class="container">
  <!-- è¿”å›æŒ‰é’® -->
  <a href="../index.html" class="back-btn">
    â† è¿”å›é¦–é¡µ
  </a>

  <!-- åŠ è½½çŠ¶æ€ -->
  <div id="loadingState" class="loading">
    åŠ è½½ä¸­...
  </div>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <div id="errorState" class="error" style="display:none">
    <div class="error-message">åŠ è½½å¤±è´¥</div>
    <button class="btn" onclick="loadReviewDetail()">é‡è¯•</button>
  </div>

  <!-- ä¹¦è¯„è¯¦æƒ… -->
  <div id="reviewDetail" class="review-detail" style="display:none">
    <!-- ä¹¦è¯„å¤´éƒ¨ -->
    <div class="review-header">
      <h1 id="reviewTitle" class="review-title"></h1>
      <div class="review-meta">
        <div class="author-info">
          <div id="authorAvatar" class="avatar"></div>
          <span id="authorName"></span>
        </div>
        <div id="reviewRating" class="rating"></div>
        <div id="reviewDate"></div>
        <div class="stats-item">
          <span>ğŸ‘ï¸</span>
          <span id="viewCount">0</span>
        </div>
      </div>
      <div id="bookInfo" class="book-info">
        <div id="bookTitle" class="book-title"></div>
        <div id="bookAuthor" class="book-author"></div>
      </div>
    </div>

    <!-- ä¹¦è¯„å†…å®¹ -->
    <div id="reviewContent" class="review-content"></div>

    <!-- äº’åŠ¨åŒºåŸŸ -->
    <div class="interaction-bar">
      <button id="likeBtn" class="action-btn">
        <span>â¤ï¸</span>
        <span id="likeText">ç‚¹èµ</span>
        <span id="likeCount">0</span>
      </button>
      <button id="favoriteBtn" class="action-btn">
        <span>â­</span>
        <span id="favoriteText">æ”¶è—</span>
      </button>
      <div class="stats-item">
        <span>ğŸ’¬</span>
        <span id="commentCount">0</span>
        <span>æ¡è¯„è®º</span>
      </div>
    </div>

    <!-- è¯„è®ºåŒºåŸŸ -->
    <div class="comments-section">
      <h3 class="section-title">è¯„è®ºåŒº</h3>
      
      <!-- è¯„è®ºè¾“å…¥æ¡† -->
      <div id="commentForm" class="comment-form" style="display:none">
        <textarea id="commentTextarea" class="comment-textarea" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
        <div class="comment-actions">
          <div class="char-count">
            <span id="charCount">0</span>/500
          </div>
          <button id="submitComment" class="submit-btn">å‘å¸ƒè¯„è®º</button>
        </div>
      </div>

      <!-- æœªç™»å½•æç¤º -->
      <div id="loginPrompt" class="comment-form" style="display:none">
        <p>è¯·å…ˆç™»å½•åå†å‘è¡¨è¯„è®º</p>
        <a href="login.html" class="btn">ç«‹å³ç™»å½•</a>
      </div>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <div id="commentsList" class="comments-list"></div>
      
      <!-- è¯„è®ºåŠ è½½çŠ¶æ€ -->
      <div id="commentsLoading" class="loading" style="display:none">
        åŠ è½½è¯„è®ºä¸­...
      </div>
      
      <!-- è¯„è®ºç©ºçŠ¶æ€ -->
      <div id="commentsEmpty" class="empty" style="display:none">
        æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼
      </div>
    </div>
  </div>
</div>

<script>
// å…¨å±€å˜é‡
let currentReviewId;
let currentUser = null;

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async function() {
  console.log('ğŸ“– ä¹¦è¯„è¯¦æƒ…é¡µé¢åˆå§‹åŒ–...');
  
  try {
    // APIå·²åœ¨api.jsä¸­è‡ªåŠ¨åˆå§‹åŒ–
    console.log('APIå·²å¯ç”¨');
    
    // è·å–URLå‚æ•°ä¸­çš„ä¹¦è¯„ID
    const urlParams = new URLSearchParams(window.location.search);
    currentReviewId = urlParams.get('id');
    
    console.log('å½“å‰ä¹¦è¯„ID:', currentReviewId);
    
    if (!currentReviewId) {
      showError('æœªæ‰¾åˆ°ä¹¦è¯„ID');
      return;
    }
    
    // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
    await checkLoginStatus();
    console.log('ç™»å½•çŠ¶æ€æ£€æŸ¥å®Œæˆ');
    
    // åŠ è½½ä¹¦è¯„è¯¦æƒ…
    await loadReviewDetail();
    console.log('ä¹¦è¯„è¯¦æƒ…åŠ è½½å®Œæˆ');
    
    // ç»‘å®šäº‹ä»¶
    bindEvents();
    console.log('äº‹ä»¶ç»‘å®šå®Œæˆ');
    
    console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
  } catch (error) {
    console.error('âŒ é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
    hideLoading();
    showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
  }
});

// æ£€æŸ¥ç™»å½•çŠ¶æ€
async function checkLoginStatus() {
  try {
    if (!api) {
      throw new Error('APIæœªåˆå§‹åŒ–');
    }
    
    // é¦–å…ˆæ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰tokenå’Œç”¨æˆ·ä¿¡æ¯
    if (api.isLoggedIn()) {
      console.log('ğŸ” æ£€æµ‹åˆ°æœ¬åœ°tokenï¼ŒéªŒè¯æœ‰æ•ˆæ€§...');
      
      // å°è¯•ä»localStorageè·å–ç”¨æˆ·ä¿¡æ¯
      const localUser = api.getCurrentUser();
      if (localUser) {
        console.log('ğŸ“‹ ä»æœ¬åœ°è·å–ç”¨æˆ·ä¿¡æ¯:', localUser);
        currentUser = localUser;
      }
      
      // éªŒè¯tokenæœ‰æ•ˆæ€§
      const response = await api.verifyToken();
      if (response.success && response.data) {
        // Tokenæœ‰æ•ˆï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯
        currentUser = response.data.user;
        console.log('âœ… TokenéªŒè¯æˆåŠŸï¼Œç”¨æˆ·å·²ç™»å½•:', currentUser.username);
        updateNavigation(true);
        showCommentForm();
      } else {
        // Tokenæ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°æ•°æ®
        console.log('âŒ Tokenæ— æ•ˆï¼Œæ¸…é™¤ç™»å½•çŠ¶æ€');
        await api.logout();
        currentUser = null;
        updateNavigation(false);
        showLoginPrompt();
      }
    } else {
      console.log('ğŸ“­ æœªæ£€æµ‹åˆ°ç™»å½•token');
      currentUser = null;
      updateNavigation(false);
      showLoginPrompt();
    }
  } catch (error) {
    console.error('âŒ æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
    // ç½‘ç»œé”™è¯¯æ—¶ï¼Œå¦‚æœæœ‰æœ¬åœ°ç”¨æˆ·ä¿¡æ¯ï¼Œä¿æŒç™»å½•çŠ¶æ€
    const localUser = api.getCurrentUser();
    if (localUser && api.isLoggedIn()) {
      console.log('ğŸ”„ ç½‘ç»œé”™è¯¯ï¼Œä½¿ç”¨æœ¬åœ°ç”¨æˆ·ä¿¡æ¯ç»´æŒç™»å½•çŠ¶æ€');
      currentUser = localUser;
      updateNavigation(true);
      showCommentForm();
    } else {
      currentUser = null;
      updateNavigation(false);
      showLoginPrompt();
    }
  }
}

// æ›´æ–°å¯¼èˆªæ 
function updateNavigation(isLoggedIn) {
  const navButtons = document.getElementById('navButtons');
  
  if (isLoggedIn) {
    navButtons.innerHTML = `
      <a href="../pages/add-review.html" class="btn">å‘å¸ƒä¹¦è¯„</a>
      <a href="../pages/profile.html" class="btn secondary">ğŸ‘¤ ä¸ªäººä¸»é¡µ</a>
      <button class="btn secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
    `;
  } else {
    navButtons.innerHTML = `
      <a href="../pages/login.html" class="btn secondary">ç™»å½•</a>
      <a href="../pages/register.html" class="btn">æ³¨å†Œ</a>
    `;
  }
}

// åŠ è½½ä¹¦è¯„è¯¦æƒ…
async function loadReviewDetail() {
  try {
    console.log('å¼€å§‹åŠ è½½ä¹¦è¯„è¯¦æƒ…ï¼ŒID:', currentReviewId);
    
    if (!api) {
      throw new Error('APIæœªåˆå§‹åŒ–');
    }
    
    if (!currentReviewId) {
      throw new Error('ä¹¦è¯„IDæ— æ•ˆ');
    }
    
    showLoading();
    
    // å…ˆè·å–ä¹¦è¯„è¯¦æƒ…
    const detailResponse = await api.getReviewById(currentReviewId);
    console.log('APIå“åº”:', detailResponse);
    
    if (detailResponse.success) {
      displayReviewDetail(detailResponse.data);
      
      // å¼‚æ­¥è®°å½•æµè§ˆé‡ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
      recordView().catch(error => {
        console.log('è®°å½•æµè§ˆé‡å¤±è´¥:', error);
      });
      
      // åŠ è½½è¯„è®º
      await loadComments();
    } else {
      hideLoading();
      showError(detailResponse.message || 'åŠ è½½ä¹¦è¯„è¯¦æƒ…å¤±è´¥');
    }
  } catch (error) {
    console.error('åŠ è½½ä¹¦è¯„è¯¦æƒ…å¤±è´¥:', error);
    hideLoading();
    showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•: ' + error.message);
  }
}

// è®°å½•æµè§ˆé‡ï¼ˆé™é»˜ï¼‰
async function recordView() {
  try {
    await api.recordView(currentReviewId);
  } catch (error) {
    console.log('è®°å½•æµè§ˆé‡å¤±è´¥:', error);
    // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ä¸»æµç¨‹
  }
}

// æ˜¾ç¤ºä¹¦è¯„è¯¦æƒ…
function displayReviewDetail(data) {
  try {
    console.log('ğŸ” å¼€å§‹æ˜¾ç¤ºä¹¦è¯„è¯¦æƒ…');
    console.log('ğŸ“„ æ”¶åˆ°çš„ä¹¦è¯„æ•°æ®:', data);
    
    // éªŒè¯æ•°æ®ç»“æ„
    if (!data) {
      throw new Error('æ•°æ®ä¸ºç©º');
    }
    
    const { review, user: author, book } = data;
    console.log('ğŸ“ è§£æ„æ•°æ® - review:', !!review, 'author:', !!author, 'book:', !!book);
    
    if (!review || !author || !book) {
      throw new Error('æ•°æ®ç»“æ„ä¸å®Œæ•´ - review:' + !!review + ', author:' + !!author + ', book:' + !!book);
    }
    
    // æ›´æ–°é¡µé¢æ ‡é¢˜
    document.title = `${review.title} - ä¹¦è¯„ç®¡ç†ç³»ç»Ÿ`;
    console.log('âœ… é¡µé¢æ ‡é¢˜å·²æ›´æ–°');
    
    // æ£€æŸ¥DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
    const requiredElements = ['reviewTitle', 'authorName', 'reviewRating', 'reviewDate', 'viewCount', 'bookTitle', 'bookAuthor', 'reviewContent'];
    for (const elementId of requiredElements) {
      if (!document.getElementById(elementId)) {
        throw new Error(`DOMå…ƒç´ ä¸å­˜åœ¨: ${elementId}`);
      }
    }
    console.log('âœ… æ‰€æœ‰å¿…éœ€çš„DOMå…ƒç´ éƒ½å­˜åœ¨');
    
    // å¡«å……ä¹¦è¯„ä¿¡æ¯
    document.getElementById('reviewTitle').textContent = review.title;
    document.getElementById('authorName').textContent = author.username || 'æœªçŸ¥ä½œè€…';
    document.getElementById('reviewRating').textContent = 'â­'.repeat(review.rating) + ` (${review.rating}/5)`;
    document.getElementById('reviewDate').textContent = formatDate(review.created_at);
    document.getElementById('viewCount').textContent = review.views || 0;
    
    // å¡«å……ä½œè€…å¤´åƒ
    const authorAvatar = document.getElementById('authorAvatar');
    if (author.avatar_url) {
      const avatarUrl = author.avatar_url.startsWith('/') 
        ? `http://localhost:3001${author.avatar_url}` 
        : author.avatar_url;
      authorAvatar.innerHTML = `<img src="${avatarUrl}" alt="${author.username}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
    }
    
    console.log('âœ… ä¹¦è¯„åŸºæœ¬ä¿¡æ¯å·²å¡«å……');
    
    // å¡«å……ä¹¦ç±ä¿¡æ¯
    document.getElementById('bookTitle').textContent = book.title;
    document.getElementById('bookAuthor').textContent = `ä½œè€…ï¼š${book.author}`;
    console.log('âœ… ä¹¦ç±ä¿¡æ¯å·²å¡«å……');
    
    // å¡«å……ä¹¦è¯„å†…å®¹
    document.getElementById('reviewContent').innerHTML = formatContent(review.content);
    console.log('âœ… ä¹¦è¯„å†…å®¹å·²å¡«å……');
    
    // æ›´æ–°äº’åŠ¨çŠ¶æ€
    updateInteractionBar(review);
    console.log('âœ… äº’åŠ¨æ å·²æ›´æ–°');
    
    // éšè—åŠ è½½çŠ¶æ€å¹¶æ˜¾ç¤ºå†…å®¹
    console.log('ğŸ”„ å‡†å¤‡éšè—åŠ è½½çŠ¶æ€...');
    hideLoading();
    console.log('ğŸ”„ å‡†å¤‡æ˜¾ç¤ºä¹¦è¯„è¯¦æƒ…...');
    showReviewDetail();
    console.log('ğŸ‰ ä¹¦è¯„è¯¦æƒ…æ˜¾ç¤ºå®Œæˆï¼');
    
  } catch (error) {
    console.error('âŒ æ˜¾ç¤ºä¹¦è¯„è¯¦æƒ…å¤±è´¥:', error);
    console.error('âŒ é”™è¯¯å †æ ˆ:', error.stack);
    hideLoading();
    showError('æ˜¾ç¤ºä¹¦è¯„è¯¦æƒ…å¤±è´¥: ' + error.message);
  }
}

// æ›´æ–°äº’åŠ¨æ 
function updateInteractionBar(review) {
  document.getElementById('likeCount').textContent = review.likes_count || 0;
  document.getElementById('commentCount').textContent = review.comments_count || 0;
  
  // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œæ›´æ–°ç‚¹èµå’Œæ”¶è—çŠ¶æ€
  if (currentUser && review.user_interaction) {
    const likeBtn = document.getElementById('likeBtn');
    const favoriteBtn = document.getElementById('favoriteBtn');
    
    if (review.user_interaction.is_liked) {
      likeBtn.classList.add('active');
      document.getElementById('likeText').textContent = 'å·²ç‚¹èµ';
    }
    
    if (review.user_interaction.is_favorited) {
      favoriteBtn.classList.add('active');
      document.getElementById('favoriteText').textContent = 'å·²æ”¶è—';
    }
  }
}

// ç»‘å®šäº‹ä»¶
function bindEvents() {
  // ç‚¹èµæŒ‰é’®
  document.getElementById('likeBtn').addEventListener('click', handleLike);
  
  // æ”¶è—æŒ‰é’®
  document.getElementById('favoriteBtn').addEventListener('click', handleFavorite);
  
  // è¯„è®ºæäº¤
  document.getElementById('submitComment').addEventListener('click', handleSubmitComment);
  
  // è¯„è®ºè¾“å…¥æ¡†å­—æ•°ç»Ÿè®¡
  document.getElementById('commentTextarea').addEventListener('input', updateCharCount);
}

// å¤„ç†ç‚¹èµ
async function handleLike() {
  if (!currentUser) {
    alert('è¯·å…ˆç™»å½•');
    return;
  }
  
  const likeBtn = document.getElementById('likeBtn');
  const likeText = document.getElementById('likeText');
  const likeCount = document.getElementById('likeCount');
  
  // è·å–å½“å‰çŠ¶æ€
  const isCurrentlyLiked = likeBtn.classList.contains('active');
  const currentCount = parseInt(likeCount.textContent) || 0;
  
  // ä¹è§‚æ›´æ–°UI
  if (isCurrentlyLiked) {
    likeBtn.classList.remove('active');
    likeText.textContent = 'ç‚¹èµ';
    likeCount.textContent = Math.max(0, currentCount - 1);
  } else {
    likeBtn.classList.add('active');
    likeText.textContent = 'å·²ç‚¹èµ';
    likeCount.textContent = currentCount + 1;
  }
  
  // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
  likeBtn.disabled = true;
  
  try {
    // è°ƒç”¨API
    const response = await api.toggleLike(currentReviewId, isCurrentlyLiked);
    
    if (response.success) {
      // æ›´æ–°ä¸ºæœåŠ¡å™¨è¿”å›çš„å®é™…æ•°æ®
      if (response.data && response.data.likes_count !== undefined) {
        likeCount.textContent = response.data.likes_count;
      }
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      showToast(isCurrentlyLiked ? 'å–æ¶ˆç‚¹èµæˆåŠŸ' : 'ç‚¹èµæˆåŠŸ');
    } else {
      // APIè°ƒç”¨å¤±è´¥ï¼Œå›æ»šUIçŠ¶æ€
      if (isCurrentlyLiked) {
        likeBtn.classList.add('active');
        likeText.textContent = 'å·²ç‚¹èµ';
        likeCount.textContent = currentCount;
      } else {
        likeBtn.classList.remove('active');
        likeText.textContent = 'ç‚¹èµ';
        likeCount.textContent = currentCount;
      }
      
      showToast(response.message || 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
  } catch (error) {
    console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
    
    // ç½‘ç»œé”™è¯¯ï¼Œå›æ»šUIçŠ¶æ€
    if (isCurrentlyLiked) {
      likeBtn.classList.add('active');
      likeText.textContent = 'å·²ç‚¹èµ';
      likeCount.textContent = currentCount;
    } else {
      likeBtn.classList.remove('active');
      likeText.textContent = 'ç‚¹èµ';
      likeCount.textContent = currentCount;
    }
    
    showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
  } finally {
    // é‡æ–°å¯ç”¨æŒ‰é’®
    likeBtn.disabled = false;
  }
}

// å¤„ç†æ”¶è—
async function handleFavorite() {
  if (!currentUser) {
    alert('è¯·å…ˆç™»å½•');
    return;
  }
  
  const favoriteBtn = document.getElementById('favoriteBtn');
  const favoriteText = document.getElementById('favoriteText');
  
  // è·å–å½“å‰çŠ¶æ€
  const isCurrentlyFavorited = favoriteBtn.classList.contains('active');
  
  // ä¹è§‚æ›´æ–°UI
  if (isCurrentlyFavorited) {
    favoriteBtn.classList.remove('active');
    favoriteText.textContent = 'æ”¶è—';
  } else {
    favoriteBtn.classList.add('active');
    favoriteText.textContent = 'å·²æ”¶è—';
  }
  
  // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
  favoriteBtn.disabled = true;
  
  try {
    // è°ƒç”¨API
    const response = await api.toggleFavorite(currentReviewId, isCurrentlyFavorited);
    
    if (response.success) {
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      showToast(isCurrentlyFavorited ? 'å–æ¶ˆæ”¶è—æˆåŠŸ' : 'æ”¶è—æˆåŠŸ');
    } else {
      // APIè°ƒç”¨å¤±è´¥ï¼Œå›æ»šUIçŠ¶æ€
      if (isCurrentlyFavorited) {
        favoriteBtn.classList.add('active');
        favoriteText.textContent = 'å·²æ”¶è—';
      } else {
        favoriteBtn.classList.remove('active');
        favoriteText.textContent = 'æ”¶è—';
      }
      
      showToast(response.message || 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
  } catch (error) {
    console.error('æ”¶è—æ“ä½œå¤±è´¥:', error);
    
    // ç½‘ç»œé”™è¯¯ï¼Œå›æ»šUIçŠ¶æ€
    if (isCurrentlyFavorited) {
      favoriteBtn.classList.add('active');
      favoriteText.textContent = 'å·²æ”¶è—';
    } else {
      favoriteBtn.classList.remove('active');
      favoriteText.textContent = 'æ”¶è—';
    }
    
    showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
  } finally {
    // é‡æ–°å¯ç”¨æŒ‰é’®
    favoriteBtn.disabled = false;
  }
}

// å¤„ç†è¯„è®ºæäº¤
async function handleSubmitComment() {
  const textarea = document.getElementById('commentTextarea');
  const submitBtn = document.getElementById('submitComment');
  const content = textarea.value.trim();
  
  if (!content) {
    showToast('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'error');
    return;
  }
  
  if (content.length > 500) {
    showToast('è¯„è®ºå†…å®¹ä¸èƒ½è¶…è¿‡500å­—ç¬¦', 'error');
    return;
  }
  
  submitBtn.disabled = true;
  submitBtn.textContent = 'å‘å¸ƒä¸­...';
  
  try {
    const response = await api.createComment(currentReviewId, content);
    
    if (response.success) {
      showToast('è¯„è®ºå‘è¡¨æˆåŠŸ');
      textarea.value = '';
      updateCharCount();
      
      // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
      await loadComments();
      
      // æ›´æ–°è¯„è®ºæ•°é‡
      const commentCount = document.getElementById('commentCount');
      const currentCount = parseInt(commentCount.textContent) || 0;
      commentCount.textContent = currentCount + 1;
    } else {
      showToast(response.message || 'å‘è¡¨è¯„è®ºå¤±è´¥', 'error');
    }
  } catch (error) {
    console.error('å‘è¡¨è¯„è®ºå¤±è´¥:', error);
    showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'å‘å¸ƒè¯„è®º';
  }
}

// æ˜¾ç¤ºå›å¤è¡¨å•
function showReplyForm(commentId) {
  // éšè—å…¶ä»–å›å¤è¡¨å•
  document.querySelectorAll('.reply-form').forEach(form => {
    form.style.display = 'none';
  });
  
  const replyForm = document.getElementById(`replyForm${commentId}`);
  const textarea = document.getElementById(`replyTextarea${commentId}`);
  
  replyForm.style.display = 'block';
  textarea.focus();
  
  // ç»‘å®šå­—æ•°ç»Ÿè®¡
  textarea.oninput = () => updateReplyCharCount(commentId);
}

// éšè—å›å¤è¡¨å•
function hideReplyForm(commentId) {
  const replyForm = document.getElementById(`replyForm${commentId}`);
  const textarea = document.getElementById(`replyTextarea${commentId}`);
  
  replyForm.style.display = 'none';
  textarea.value = '';
  updateReplyCharCount(commentId);
}

// æäº¤å›å¤
async function submitReply(commentId) {
  const textarea = document.getElementById(`replyTextarea${commentId}`);
  const content = textarea.value.trim();
  
  if (!content) {
    showToast('è¯·è¾“å…¥å›å¤å†…å®¹', 'error');
    return;
  }
  
  if (content.length > 500) {
    showToast('å›å¤å†…å®¹ä¸èƒ½è¶…è¿‡500å­—ç¬¦', 'error');
    return;
  }
  
  try {
    const response = await api.replyToComment(commentId, content);
    
    if (response.success) {
      showToast('å›å¤å‘è¡¨æˆåŠŸ');
      hideReplyForm(commentId);
      
      // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
      await loadComments();
      
      // æ›´æ–°è¯„è®ºæ•°é‡
      const commentCount = document.getElementById('commentCount');
      const currentCount = parseInt(commentCount.textContent) || 0;
      commentCount.textContent = currentCount + 1;
    } else {
      showToast(response.message || 'å‘è¡¨å›å¤å¤±è´¥', 'error');
    }
  } catch (error) {
    console.error('å‘è¡¨å›å¤å¤±è´¥:', error);
    showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
  }
}

// åˆ é™¤è¯„è®º
async function deleteComment(commentId) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
    return;
  }
  
  try {
    const response = await api.deleteComment(commentId);
    
    if (response.success) {
      showToast('è¯„è®ºåˆ é™¤æˆåŠŸ');
      
      // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
      await loadComments();
      
      // æ›´æ–°è¯„è®ºæ•°é‡
      const commentCount = document.getElementById('commentCount');
      const currentCount = parseInt(commentCount.textContent) || 0;
      commentCount.textContent = Math.max(0, currentCount - 1);
    } else {
      showToast(response.message || 'åˆ é™¤è¯„è®ºå¤±è´¥', 'error');
    }
  } catch (error) {
    console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
    showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
  }
}

// æ›´æ–°å›å¤å­—æ•°ç»Ÿè®¡
function updateReplyCharCount(commentId) {
  const textarea = document.getElementById(`replyTextarea${commentId}`);
  const charCount = document.getElementById(`replyCharCount${commentId}`);
  
  if (textarea && charCount) {
    const length = textarea.value.length;
    charCount.textContent = length;
    
    // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
    const submitBtn = textarea.parentElement.querySelector('.submit-btn');
    if (submitBtn) {
      submitBtn.disabled = length === 0 || length > 500;
    }
  }
}

// åŠ è½½è¯„è®º
async function loadComments() {
  try {
    document.getElementById('commentsLoading').style.display = 'block';
    document.getElementById('commentsEmpty').style.display = 'none';
    document.getElementById('commentsList').innerHTML = '';
    
    const response = await api.getReviewComments(currentReviewId);
    
    if (response.success && response.data.comments) {
      const comments = response.data.comments;
      
      if (comments.length === 0) {
        document.getElementById('commentsEmpty').style.display = 'block';
      } else {
        displayComments(comments);
      }
    } else {
      console.error('åŠ è½½è¯„è®ºå¤±è´¥:', response.message);
      document.getElementById('commentsEmpty').style.display = 'block';
    }
  } catch (error) {
    console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
    document.getElementById('commentsEmpty').style.display = 'block';
  } finally {
    document.getElementById('commentsLoading').style.display = 'none';
  }
}

// æ˜¾ç¤ºè¯„è®ºåˆ—è¡¨
function displayComments(comments) {
  const commentsList = document.getElementById('commentsList');
  
  // å°†è¯„è®ºæŒ‰å±‚çº§ç»„ç»‡
  const topLevelComments = comments.filter(comment => !comment.parent_id);
  const repliesMap = {};
  
  comments.forEach(comment => {
    if (comment.parent_id) {
      if (!repliesMap[comment.parent_id]) {
        repliesMap[comment.parent_id] = [];
      }
      repliesMap[comment.parent_id].push(comment);
    }
  });
  
  // æ¸²æŸ“é¡¶çº§è¯„è®ºå’Œå›å¤
  const commentsHtml = topLevelComments.map(comment => {
    const replies = repliesMap[comment.id] || [];
    return renderComment(comment, replies);
  }).join('');
  
  commentsList.innerHTML = commentsHtml;
}

// æ¸²æŸ“å•ä¸ªè¯„è®º
function renderComment(comment, replies = []) {
  const isAuthor = currentUser && currentUser.id === comment.user_id;
  const canDelete = isAuthor || (currentUser && currentUser.role === 'admin');
  
  const repliesHtml = replies.map(reply => `
    <div class="reply-item">
      <div class="comment-header">
        <div class="comment-author">
          ${getAvatarHtml(reply.avatar_url, reply.username)}
          <span>${escapeHtml(reply.username)}</span>
          ${reply.user_id === comment.review_author_id ? '<span class="author-badge">ä½œè€…</span>' : ''}
        </div>
        <div class="comment-time">${formatDate(reply.created_at)}</div>
      </div>
      <div class="comment-content">${escapeHtml(reply.content)}</div>
      <div class="comment-actions">
        ${currentUser && currentUser.id !== reply.user_id ? `<span class="comment-action" onclick="showReplyForm(${reply.id})">å›å¤</span>` : ''}
        ${(currentUser && currentUser.id === reply.user_id) || (currentUser && currentUser.role === 'admin') ? `<span class="comment-action" onclick="deleteComment(${reply.id})">åˆ é™¤</span>` : ''}
      </div>
    </div>
  `).join('');
  
  return `
    <div class="comment-item" data-comment-id="${comment.id}">
      <div class="comment-header">
        <div class="comment-author">
          ${getAvatarHtml(comment.avatar_url, comment.username)}
          <span>${escapeHtml(comment.username)}</span>
          ${comment.user_id === comment.review_author_id ? '<span class="author-badge">ä½œè€…</span>' : ''}
        </div>
        <div class="comment-time">${formatDate(comment.created_at)}</div>
      </div>
      <div class="comment-content">${escapeHtml(comment.content)}</div>
      <div class="comment-actions">
        ${currentUser ? `<span class="comment-action" onclick="showReplyForm(${comment.id})">å›å¤</span>` : ''}
        ${canDelete ? `<span class="comment-action" onclick="deleteComment(${comment.id})">åˆ é™¤</span>` : ''}
      </div>
      <div id="replyForm${comment.id}" class="reply-form" style="display:none">
        <textarea id="replyTextarea${comment.id}" class="comment-textarea" placeholder="å›å¤ ${escapeHtml(comment.username)}..."></textarea>
        <div class="comment-actions">
          <span class="char-count">
            <span id="replyCharCount${comment.id}">0</span>/500
          </span>
          <button onclick="submitReply(${comment.id})" class="submit-btn">å‘å¸ƒå›å¤</button>
          <button onclick="hideReplyForm(${comment.id})" class="submit-btn secondary" style="margin-left:8px">å–æ¶ˆ</button>
        </div>
      </div>
      ${repliesHtml ? `<div class="replies">${repliesHtml}</div>` : ''}
    </div>
  `;
}

// æ›´æ–°å­—æ•°ç»Ÿè®¡
function updateCharCount() {
  const textarea = document.getElementById('commentTextarea');
  const charCount = document.getElementById('charCount');
  const submitBtn = document.getElementById('submitComment');
  
  const length = textarea.value.length;
  charCount.textContent = length;
  
  submitBtn.disabled = length === 0 || length > 500;
}

// æ˜¾ç¤ºè¯„è®ºè¾“å…¥æ¡†
function showCommentForm() {
  document.getElementById('commentForm').style.display = 'block';
  document.getElementById('loginPrompt').style.display = 'none';
}

// æ˜¾ç¤ºç™»å½•æç¤º
function showLoginPrompt() {
  document.getElementById('commentForm').style.display = 'none';
  document.getElementById('loginPrompt').style.display = 'block';
}

// é€€å‡ºç™»å½•
async function logout() {
  try {
    await api.logout();
    localStorage.removeItem('auth_token');
    window.location.href = '../index.html';
  } catch (error) {
    console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
    // å³ä½¿APIè°ƒç”¨å¤±è´¥ï¼Œä¹Ÿæ¸…é™¤æœ¬åœ°token
    localStorage.removeItem('auth_token');
    window.location.href = '../index.html';
  }
}

// å·¥å…·å‡½æ•°
function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ç”Ÿæˆå¤´åƒ HTML
function getAvatarHtml(avatarUrl, username = '') {
  if (!avatarUrl) {
    return '<div class="avatar"></div>';
  }
  
  const fullUrl = avatarUrl.startsWith('/') 
    ? `http://localhost:3001${avatarUrl}` 
    : avatarUrl;
  
  return `<img src="${fullUrl}" alt="${escapeHtml(username)}" class="avatar" style="object-fit:cover;">`;
}

function formatContent(content) {
  // ä½¿ç”¨ marked.js æ¸²æŸ“ Markdown
  if (typeof marked !== 'undefined') {
    try {
      // é…ç½® marked é€‰é¡¹
      marked.setOptions({
        breaks: true,        // æ”¯æŒæ¢è¡Œ
        gfm: true,          // æ”¯æŒ GitHub é£æ ¼çš„ Markdown
        headerIds: false,   // ç¦ç”¨è‡ªåŠ¨ç”Ÿæˆçš„æ ‡é¢˜ ID
        mangle: false       // ç¦ç”¨é‚®ç®±åœ°å€æ··æ·†
      });
      
      return marked.parse(content);
    } catch (error) {
      console.error('âŒ Markdown æ¸²æŸ“å¤±è´¥:', error);
      // é™çº§ï¼šç®€å•çš„æ¢è¡Œç¬¦è½¬æ¢
      return content.replace(/\n/g, '<br>');
    }
  } else {
    console.warn('âš ï¸ marked.js æœªåŠ è½½ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ');
    // é™çº§ï¼šç®€å•çš„æ¢è¡Œç¬¦è½¬æ¢
    return content.replace(/\n/g, '<br>');
  }
}

function showLoading() {
  console.log('ğŸ”„ æ˜¾ç¤ºåŠ è½½çŠ¶æ€');
  document.getElementById('loadingState').style.display = 'block';
  document.getElementById('errorState').style.display = 'none';
  document.getElementById('reviewDetail').style.display = 'none';
}

function hideLoading() {
  console.log('ğŸ”„ éšè—åŠ è½½çŠ¶æ€');
  document.getElementById('loadingState').style.display = 'none';
}

function showError(message) {
  console.log('âŒ æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯:', message);
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('errorState').style.display = 'block';
  document.getElementById('reviewDetail').style.display = 'none';
  document.querySelector('.error-message').textContent = message;
}

function showReviewDetail() {
  console.log('ğŸ“– æ˜¾ç¤ºä¹¦è¯„è¯¦æƒ…');
  const reviewElement = document.getElementById('reviewDetail');
  if (reviewElement) {
    reviewElement.style.display = 'block';
    console.log('âœ… ä¹¦è¯„è¯¦æƒ…å…ƒç´ å·²æ˜¾ç¤º');
  } else {
    console.error('âŒ æ‰¾ä¸åˆ°ä¹¦è¯„è¯¦æƒ…å…ƒç´ ');
  }
}

// Toastæç¤ºåŠŸèƒ½
function showToast(message, type = 'success') {
  // ç§»é™¤ç°æœ‰çš„toast
  const existingToast = document.querySelector('.toast');
  if (existingToast) {
    existingToast.remove();
  }
  
  // åˆ›å»ºæ–°çš„toast
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  
  document.body.appendChild(toast);
  
  // æ˜¾ç¤ºtoast
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  // 3ç§’åè‡ªåŠ¨éšè—
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (toast.parentNode) {
        toast.remove();
      }
    }, 300);
  }, 3000);
}
</script>
</body>
</html>
